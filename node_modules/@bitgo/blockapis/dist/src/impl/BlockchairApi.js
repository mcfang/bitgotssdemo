"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BlockchairApi = void 0;
const utxo_lib_1 = require("@bitgo/utxo-lib");
const BaseHttpClient_1 = require("../BaseHttpClient");
const ApiBuilder_1 = require("../ApiBuilder");
const formatOutputId = utxo_lib_1.bitgo.formatOutputId;
class ErrorKeyNotInResponse extends Error {
    constructor(key) {
        super(`key ${key} not in response`);
    }
}
function unwrapRecord(body, key) {
    if (!(key in body.data)) {
        throw new ErrorKeyNotInResponse(key);
    }
    return body.data[key];
}
class BlockchairApi {
    constructor(client, apiToken) {
        this.client = client;
        this.apiToken = apiToken !== null && apiToken !== void 0 ? apiToken : process.env.BLOCKCHAIR_TOKEN;
    }
    static forCoin(coinName, params = {}) {
        // https://blockchair.com/api/docs#link_M0
        let blockchain;
        switch (coinName) {
            case 'btc':
                blockchain = 'bitcoin';
                break;
            case 'tbtc':
                blockchain = 'bitcoin/testnet';
                break;
            case 'bsv':
                blockchain = 'bitcoin-sv';
                break;
            case 'bch':
                blockchain = 'bitcoin-cash';
                break;
            case 'bcha':
                blockchain = 'ecash';
                break;
            case 'ltc':
                blockchain = 'litecoin';
                break;
            case 'dash':
                blockchain = 'dash';
                break;
            case 'doge':
                blockchain = 'dogecoin';
                break;
            case 'zec':
                blockchain = 'zcash';
                break;
            default:
                throw new ApiBuilder_1.ApiNotImplementedError(coinName);
        }
        const { httpClient = new BaseHttpClient_1.BaseHttpClient() } = params;
        return new BlockchairApi(httpClient.withBaseUrl(`https://api.blockchair.com/${blockchain}`), params.apiToken);
    }
    get(path) {
        return this.client.get(path + (this.apiToken ? `?key=${this.apiToken}` : ''));
    }
    async getAddressInfo(address) {
        if (!address || address.length === 0) {
            throw new Error('invalid address');
        }
        // https://blockchair.com/api/docs#link_300
        return (await this.get(`/dashboards/address/${address}`)).map((body) => {
            return {
                txCount: body.data[address].address.transaction_count,
                balance: body.data[address].address.balance,
            };
        });
    }
    async getUnspentsForAddresses(addr) {
        if (addr.length > 100) {
            throw new Error(`invalid size`);
        }
        // https://blockchair.com/api/docs#link_300
        return (await this.get(`/dashboards/addresses/${addr.join(',')}`)).map((body) => {
            return addr.flatMap((a) => {
                return body.data.utxo.map((unspent) => {
                    return {
                        id: formatOutputId({ txid: unspent.transaction_hash, vout: unspent.index }),
                        address: a,
                        value: unspent.value,
                    };
                });
            });
        });
    }
    async getTransaction(txid) {
        return (await this.get(`/dashboards/transaction/${txid}`)).map((body) => {
            return unwrapRecord(body, txid);
        });
    }
    async getTransactionStatus(txid) {
        let transaction;
        try {
            transaction = (await this.getTransaction(txid)).transaction;
        }
        catch (e) {
            if (e instanceof ErrorKeyNotInResponse) {
                return { found: false };
            }
            throw e;
        }
        const { block_id, time } = transaction;
        const date = new Date(Date.parse(time.replace(' ', 'T') + '.000Z' /* force UTC parsing */));
        return block_id === -1
            ? { found: true, confirmed: false }
            : {
                found: true,
                confirmed: true,
                blockHeight: block_id,
                date,
            };
    }
    async getTransactionInputs(txid) {
        return (await this.getTransaction(txid)).inputs.map((i) => {
            return {
                id: formatOutputId({ txid: i.transaction_hash, vout: i.index }),
                address: i.recipient,
                value: i.value,
            };
        });
    }
    async getTransactionIO(txid) {
        const tx = await this.getTransaction(txid);
        const inputs = tx.inputs.map((input) => {
            return {
                address: input.recipient,
            };
        });
        const outputs = tx.outputs.map((output) => {
            return {
                address: output.recipient,
            };
        });
        return {
            inputs,
            outputs,
        };
    }
    async getTransactionSpends(txid) {
        return (await this.getTransaction(txid)).outputs.map((o) => o.spending_transaction_hash
            ? {
                txid: o.spending_transaction_hash,
                vin: o.spending_index,
            }
            : { txid: undefined, vin: undefined });
    }
    async getTransactionHex(txid) {
        return (await this.get(`/raw/transaction/${txid}`)).map((body) => {
            return unwrapRecord(body, txid).raw_transaction;
        });
    }
}
exports.BlockchairApi = BlockchairApi;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmxvY2tjaGFpckFwaS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9pbXBsL0Jsb2NrY2hhaXJBcGkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsOENBQXdDO0FBQ3hDLHNEQUF5RTtBQUN6RSw4Q0FBdUQ7QUFNdkQsTUFBTSxjQUFjLEdBQUcsZ0JBQUssQ0FBQyxjQUFjLENBQUM7QUFRNUMsTUFBTSxxQkFBc0IsU0FBUSxLQUFLO0lBQ3ZDLFlBQVksR0FBVztRQUNyQixLQUFLLENBQUMsT0FBTyxHQUFHLGtCQUFrQixDQUFDLENBQUM7SUFDdEMsQ0FBQztDQUNGO0FBRUQsU0FBUyxZQUFZLENBQUksSUFBaUMsRUFBRSxHQUFXO0lBQ3JFLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDdkIsTUFBTSxJQUFJLHFCQUFxQixDQUFDLEdBQUcsQ0FBQyxDQUFDO0tBQ3RDO0lBQ0QsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3hCLENBQUM7QUFtREQsTUFBYSxhQUFhO0lBeUN4QixZQUFtQixNQUFrQixFQUFFLFFBQWlCO1FBQXJDLFdBQU0sR0FBTixNQUFNLENBQVk7UUFDbkMsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLGFBQVIsUUFBUSxjQUFSLFFBQVEsR0FBSSxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDO0lBQzNELENBQUM7SUF4Q0QsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFnQixFQUFFLFNBQXlELEVBQUU7UUFDMUYsMENBQTBDO1FBQzFDLElBQUksVUFBVSxDQUFDO1FBQ2YsUUFBUSxRQUFRLEVBQUU7WUFDaEIsS0FBSyxLQUFLO2dCQUNSLFVBQVUsR0FBRyxTQUFTLENBQUM7Z0JBQ3ZCLE1BQU07WUFDUixLQUFLLE1BQU07Z0JBQ1QsVUFBVSxHQUFHLGlCQUFpQixDQUFDO2dCQUMvQixNQUFNO1lBQ1IsS0FB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QUUsRUFBRSxDQUN6RCxDQUFDLENBQUMseUJBQXlCO1lBQ3pCLENBQUMsQ0FBQztnQkFDRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLHlCQUF5QjtnQkFDakMsR0FBRyxFQUFFLENBQUMsQ0FBQyxjQUFjO2FBQ3RCO1lBQ0gsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLENBQ3hDLENBQUM7SUFDSixDQUFDO0lBRUQsS0FBSyxDQUFDLGlCQUFpQixDQUFDLElBQVk7UUFDbEMsT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBcUQsb0JBQW9CLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQ3pHLENBQUMsSUFBSSxFQUFFLEVBQUU7WUFDUCxPQUFPLFlBQVksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsZUFBZSxDQUFDO1FBQ2xELENBQUMsQ0FDRixDQUFDO0lBQ0osQ0FBQztDQUNGO0FBaEtELHNDQWdLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGJpdGdvIH0gZnJvbSAnQGJpdGdvL3V0eG8tbGliJztcbmltcG9ydCB7IEJhc2VIdHRwQ2xpZW50LCBIdHRwQ2xpZW50LCBSZXNwb25zZSB9IGZyb20gJy4uL0Jhc2VIdHRwQ2xpZW50JztcbmltcG9ydCB7IEFwaU5vdEltcGxlbWVudGVkRXJyb3IgfSBmcm9tICcuLi9BcGlCdWlsZGVyJztcbmltcG9ydCB7IEFkZHJlc3NBcGksIEFkZHJlc3NJbmZvIH0gZnJvbSAnLi4vQWRkcmVzc0FwaSc7XG5pbXBvcnQgeyBPdXRwdXRTcGVuZCwgVHJhbnNhY3Rpb25JTywgVXR4b0FwaSB9IGZyb20gJy4uL1V0eG9BcGknO1xuaW1wb3J0IHsgVHJhbnNhY3Rpb25TdGF0dXMgfSBmcm9tICcuLi9UcmFuc2FjdGlvbkFwaSc7XG5cbnR5cGUgVW5zcGVudCA9IGJpdGdvLlVuc3BlbnQ7XG5jb25zdCBmb3JtYXRPdXRwdXRJZCA9IGJpdGdvLmZvcm1hdE91dHB1dElkO1xuXG50eXBlIEJsb2NrY2hhaXJSZXNwb25zZTxUPiA9IHtcbiAgZGF0YTogVDtcbn07XG5cbnR5cGUgQmxvY2tjaGFpclJlY29yZFJlc3BvbnNlPFQ+ID0gQmxvY2tjaGFpclJlc3BvbnNlPFJlY29yZDxzdHJpbmcsIFQ+PjtcblxuY2xhc3MgRXJyb3JLZXlOb3RJblJlc3BvbnNlIGV4dGVuZHMgRXJyb3Ige1xuICBjb25zdHJ1Y3RvcihrZXk6IHN0cmluZykge1xuICAgIHN1cGVyKGBrZXkgJHtrZXl9IG5vdCBpbiByZXNwb25zZWApO1xuICB9XG59XG5cbmZ1bmN0aW9uIHVud3JhcFJlY29yZDxUPihib2R5OiBCbG9ja2NoYWlyUmVjb3JkUmVzcG9uc2U8VD4sIGtleTogc3RyaW5nKTogVCB7XG4gIGlmICghKGtleSBpbiBib2R5LmRhdGEpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yS2V5Tm90SW5SZXNwb25zZShrZXkpO1xuICB9XG4gIHJldHVybiBib2R5LmRhdGFba2V5XTtcbn1cblxuLy8gaHR0cHM6Ly9ibG9ja2NoYWlyLmNvbS9hcGkvZG9jcyNsaW5rXzMwMFxudHlwZSBCbG9ja2NoYWlyVW5zcGVudCA9IHtcbiAgdHJhbnNhY3Rpb25faGFzaDogc3RyaW5nO1xuICBpbmRleDogbnVtYmVyO1xuICByZWNpcGllbnQ6IHN0cmluZztcbiAgdmFsdWU6IG51bWJlcjtcbiAgYmxvY2tfaWQ6IG51bWJlcjtcbiAgc2NyaXB0X2hleDogc3RyaW5nO1xuICBzcGVuZGluZ190cmFuc2FjdGlvbl9oYXNoOiBzdHJpbmc7XG4gIHNwZW5kaW5nX2luZGV4OiBudW1iZXI7XG59O1xuXG4vLyBodHRwczovL2Jsb2NrY2hhaXIuY29tL2FwaS9kb2NzI2xpbmtfMzAwXG50eXBlIEJsb2NrY2hhaXJBZGRyZXNzID0ge1xuICBhZGRyZXNzOiB7XG4gICAgdHJhbnNhY3Rpb25faGFzaDogc3RyaW5nO1xuICAgIC8vIHZvdXRcbiAgICBpbmRleDogbnVtYmVyO1xuICAgIHZhbHVlOiBudW1iZXI7XG4gICAgYmxvY2tfaWQ6IG51bWJlcjtcbiAgICB0cmFuc2FjdGlvbl9jb3VudDogbnVtYmVyO1xuICAgIGJhbGFuY2U6IG51bWJlcjtcbiAgfTtcbiAgdXR4bzogQmxvY2tjaGFpclVuc3BlbnRbXTtcbn07XG5cbi8vIGh0dHBzOi8vYmxvY2tjaGFpci5jb20vYXBpL2RvY3MjbGlua18yMDBcbnR5cGUgQmxvY2tjaGFpclRyYW5zYWN0aW9uID0ge1xuICB0cmFuc2FjdGlvbjoge1xuICAgIC8qKlxuICAgICAgVGhlIGJsb2NrIG51bWJlciBpdCdzIGluY2x1ZGVkIGluLlxuICAgICAgSWYgdGhlIHRyYW5zYWN0aW9uIGlzIGluIHRoZSBtZW1wb29sLCBkYXRhLns6aGFzaH3htaIudHJhbnNhY3Rpb24uYmxvY2tfaWQgeWllbGRzIC0xXG4gICAgKi9cbiAgICBibG9ja19pZDogbnVtYmVyO1xuICAgIC8qKlxuICAgICAqIExpa2UgaHR0cHM6Ly90YzM5LmVzL2VjbWEyNjIvI3NlYy1kYXRlLXRpbWUtc3RyaW5nLWZvcm1hdCBidXQgd2l0aCBhIHNwYWNlIGluc3RlYWQgb2YgJ1QnXG4gICAgICogWVlZWS1NTS1ERCBISDptbTpzc1xuICAgICAqL1xuICAgIHRpbWU6IHN0cmluZztcbiAgfTtcbiAgaW5wdXRzOiBCbG9ja2NoYWlyVW5zcGVudFtdO1xuICBvdXRwdXRzOiBCbG9ja2NoYWlyVW5zcGVudFtdO1xufTtcblxuLy8gaHR0cHM6Ly9ibG9ja2NoYWlyLmNvbS9hcGkvZG9jcyNsaW5rXzIwMVxudHlwZSBCbG9ja2NoYWlyUmF3VHJhbnNhY3Rpb24gPSB7XG4gIHJhd190cmFuc2FjdGlvbjogc3RyaW5nO1xufTtcblxuZXhwb3J0IGNsYXNzIEJsb2NrY2hhaXJBcGkgaW1wbGVtZW50cyBBZGRyZXNzQXBpLCBVdHhvQXBpIHtcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGFwaVRva2VuPzogc3RyaW5nO1xuXG4gIHN0YXRpYyBmb3JDb2luKGNvaW5OYW1lOiBzdHJpbmcsIHBhcmFtczogeyBhcGlUb2tlbj86IHN0cmluZzsgaHR0cENsaWVudD86IEh0dHBDbGllbnQgfSA9IHt9KTogQmxvY2tjaGFpckFwaSB7XG4gICAgLy8gaHR0cHM6Ly9ibG9ja2NoYWlyLmNvbS9hcGkvZG9jcyNsaW5rX00wXG4gICAgbGV0IGJsb2NrY2hhaW47XG4gICAgc3dpdGNoIChjb2luTmFtZSkge1xuICAgICAgY2FzZSAnYnRjJzpcbiAgICAgICAgYmxvY2tjaGFpbiA9ICdiaXRjb2luJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICd0YnRjJzpcbiAgICAgICAgYmxvY2tjaGFpbiA9ICdiaXRjb2luL3Rlc3RuZXQnO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2Jzdic6XG4gICAgICAgIGJsb2NrY2hhaW4gPSAnYml0Y29pbi1zdic7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnYmNoJzpcbiAgICAgICAgYmxvY2tjaGFpbiA9ICdiaXRjb2luLWNhc2gnO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2JjaGEnOlxuICAgICAgICBibG9ja2NoYWluID0gJ2VjYXNoJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdsdGMnOlxuICAgICAgICBibG9ja2NoYWluID0gJ2xpdGVjb2luJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdkYXNoJzpcbiAgICAgICAgYmxvY2tjaGFpbiA9ICdkYXNoJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdkb2dlJzpcbiAgICAgICAgYmxvY2tjaGFpbiA9ICdkb2dlY29pbic7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnemVjJzpcbiAgICAgICAgYmxvY2tjaGFpbiA9ICd6Y2FzaCc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IEFwaU5vdEltcGxlbWVudGVkRXJyb3IoY29pbk5hbWUpO1xuICAgIH1cbiAgICBjb25zdCB7IGh0dHBDbGllbnQgPSBuZXcgQmFzZUh0dHBDbGllbnQoKSB9ID0gcGFyYW1zO1xuICAgIHJldHVybiBuZXcgQmxvY2tjaGFpckFwaShodHRwQ2xpZW50LndpdGhCYXNlVXJsKGBodHRwczovL2FwaS5ibG9ja2NoYWlyLmNvbS8ke2Jsb2NrY2hhaW59YCksIHBhcmFtcy5hcGlUb2tlbik7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgY2xpZW50OiBIdHRwQ2xpZW50LCBhcGlUb2tlbj86IHN0cmluZykge1xuICAgIHRoaXMuYXBpVG9rZW4gPSBhcGlUb2tlbiA/PyBwcm9jZXNzLmVudi5CTE9DS0NIQUlSX1RPS0VOO1xuICB9XG5cbiAgZ2V0PFQ+KHBhdGg6IHN0cmluZyk6IFByb21pc2U8UmVzcG9uc2U8VD4+IHtcbiAgICByZXR1cm4gdGhpcy5jbGllbnQuZ2V0KHBhdGggKyAodGhpcy5hcGlUb2tlbiA/IGA/a2V5PSR7dGhpcy5hcGlUb2tlbn1gIDogJycpKTtcbiAgfVxuXG4gIGFzeW5jIGdldEFkZHJlc3NJbmZvKGFkZHJlc3M6IHN0cmluZyk6IFByb21pc2U8QWRkcmVzc0luZm8+IHtcbiAgICBpZiAoIWFkZHJlc3MgfHwgYWRkcmVzcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBhZGRyZXNzJyk7XG4gICAgfVxuICAgIC8vIGh0dHBzOi8vYmxvY2tjaGFpci5jb20vYXBpL2RvY3MjbGlua18zMDBcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0PEJsb2NrY2hhaXJSZWNvcmRSZXNwb25zZTxCbG9ja2NoYWlyQWRkcmVzcz4+KGAvZGFzaGJvYXJkcy9hZGRyZXNzLyR7YWRkcmVzc31gKSkubWFwKFxuICAgICAgKGJvZHkpID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB0eENvdW50OiBib2R5LmRhdGFbYWRkcmVzc10uYWRkcmVzcy50cmFuc2FjdGlvbl9jb3VudCxcbiAgICAgICAgICBiYWxhbmNlOiBib2R5LmRhdGFbYWRkcmVzc10uYWRkcmVzcy5iYWxhbmNlLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBhc3luYyBnZXRVbnNwZW50c0ZvckFkZHJlc3NlcyhhZGRyOiBzdHJpbmdbXSk6IFByb21pc2U8VW5zcGVudFtdPiB7XG4gICAgaWYgKGFkZHIubGVuZ3RoID4gMTAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgc2l6ZWApO1xuICAgIH1cbiAgICAvLyBodHRwczovL2Jsb2NrY2hhaXIuY29tL2FwaS9kb2NzI2xpbmtfMzAwXG4gICAgcmV0dXJuIChcbiAgICAgIGF3YWl0IHRoaXMuZ2V0PEJsb2NrY2hhaXJSZXNwb25zZTx7IHV0eG86IEJsb2NrY2hhaXJVbnNwZW50W10gfT4+KGAvZGFzaGJvYXJkcy9hZGRyZXNzZXMvJHthZGRyLmpvaW4oJywnKX1gKVxuICAgICkubWFwKChib2R5KSA9PiB7XG4gICAgICByZXR1cm4gYWRkci5mbGF0TWFwKChhKSA9PiB7XG4gICAgICAgIHJldHVybiBib2R5LmRhdGEudXR4by5tYXAoKHVuc3BlbnQpOiBVbnNwZW50ID0+IHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgaWQ6IGZvcm1hdE91dHB1dElkKHsgdHhpZDogdW5zcGVudC50cmFuc2FjdGlvbl9oYXNoLCB2b3V0OiB1bnNwZW50LmluZGV4IH0pLFxuICAgICAgICAgICAgYWRkcmVzczogYSxcbiAgICAgICAgICAgIHZhbHVlOiB1bnNwZW50LnZhbHVlLFxuICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBnZXRUcmFuc2FjdGlvbih0eGlkOiBzdHJpbmcpOiBQcm9taXNlPEJsb2NrY2hhaXJUcmFuc2FjdGlvbj4ge1xuICAgIHJldHVybiAoYXdhaXQgdGhpcy5nZXQ8QmxvY2tjaGFpclJlY29yZFJlc3BvbnNlPEJsb2NrY2hhaXJUcmFuc2FjdGlvbj4+KGAvZGFzaGJvYXJkcy90cmFuc2FjdGlvbi8ke3R4aWR9YCkpLm1hcChcbiAgICAgIChib2R5KSA9PiB7XG4gICAgICAgIHJldHVybiB1bndyYXBSZWNvcmQoYm9keSwgdHhpZCk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGdldFRyYW5zYWN0aW9uU3RhdHVzKHR4aWQ6IHN0cmluZyk6IFByb21pc2U8VHJhbnNhY3Rpb25TdGF0dXM+IHtcbiAgICBsZXQgdHJhbnNhY3Rpb247XG4gICAgdHJ5IHtcbiAgICAgIHRyYW5zYWN0aW9uID0gKGF3YWl0IHRoaXMuZ2V0VHJhbnNhY3Rpb24odHhpZCkpLnRyYW5zYWN0aW9uO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChlIGluc3RhbmNlb2YgRXJyb3JLZXlOb3RJblJlc3BvbnNlKSB7XG4gICAgICAgIHJldHVybiB7IGZvdW5kOiBmYWxzZSB9O1xuICAgICAgfVxuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gICAgY29uc3QgeyBibG9ja19pZCwgdGltZSB9ID0gdHJhbnNhY3Rpb247XG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKERhdGUucGFyc2UodGltZS5yZXBsYWNlKCcgJywgJ1QnKSArICcuMDAwWicgLyogZm9yY2UgVVRDIHBhcnNpbmcgKi8pKTtcbiAgICByZXR1cm4gYmxvY2tfaWQgPT09IC0xXG4gICAgICA/IHsgZm91bmQ6IHRydWUsIGNvbmZpcm1lZDogZmFsc2UgfVxuICAgICAgOiB7XG4gICAgICAgICAgZm91bmQ6IHRydWUsXG4gICAgICAgICAgY29uZmlybWVkOiB0cnVlLFxuICAgICAgICAgIGJsb2NrSGVpZ2h0OiBibG9ja19pZCxcbiAgICAgICAgICBkYXRlLFxuICAgICAgICB9O1xuICB9XG5cbiAgYXN5bmMgZ2V0VHJhbnNhY3Rpb25JbnB1dHModHhpZDogc3RyaW5nKTogUHJvbWlzZTxVbnNwZW50W10+IHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0VHJhbnNhY3Rpb24odHhpZCkpLmlucHV0cy5tYXAoKGkpID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlkOiBmb3JtYXRPdXRwdXRJZCh7IHR4aWQ6IGkudHJhbnNhY3Rpb25faGFzaCwgdm91dDogaS5pbmRleCB9KSxcbiAgICAgICAgYWRkcmVzczogaS5yZWNpcGllbnQsXG4gICAgICAgIHZhbHVlOiBpLnZhbHVlLFxuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGdldFRyYW5zYWN0aW9uSU8odHhpZDogc3RyaW5nKTogUHJvbWlzZTxUcmFuc2FjdGlvbklPPiB7XG4gICAgY29uc3QgdHggPSBhd2FpdCB0aGlzLmdldFRyYW5zYWN0aW9uKHR4aWQpO1xuICAgIGNvbnN0IGlucHV0cyA9IHR4LmlucHV0cy5tYXAoKGlucHV0KSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBhZGRyZXNzOiBpbnB1dC5yZWNpcGllbnQsXG4gICAgICB9O1xuICAgIH0pO1xuICAgIGNvbnN0IG91dHB1dHMgPSB0eC5vdXRwdXRzLm1hcCgob3V0cHV0KSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBhZGRyZXNzOiBvdXRwdXQucmVjaXBpZW50LFxuICAgICAgfTtcbiAgICB9KTtcbiAgICByZXR1cm4ge1xuICAgICAgaW5wdXRzLFxuICAgICAgb3V0cHV0cyxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgZ2V0VHJhbnNhY3Rpb25TcGVuZHModHhpZDogc3RyaW5nKTogUHJvbWlzZTxPdXRwdXRTcGVuZFtdPiB7XG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLmdldFRyYW5zYWN0aW9uKHR4aWQpKS5vdXRwdXRzLm1hcCgobykgPT5cbiAgICAgIG8uc3BlbmRpbmdfdHJhbnNhY3Rpb25faGFzaFxuICAgICAgICA/IHtcbiAgICAgICAgICAgIHR4aWQ6IG8uc3BlbmRpbmdfdHJhbnNhY3Rpb25faGFzaCxcbiAgICAgICAgICAgIHZpbjogby5zcGVuZGluZ19pbmRleCxcbiAgICAgICAgICB9XG4gICAgICAgIDogeyB0eGlkOiB1bmRlZmluZWQsIHZpbjogdW5kZWZpbmVkIH1cbiAgICApO1xuICB9XG5cbiAgYXN5bmMgZ2V0VHJhbnNhY3Rpb25IZXgodHhpZDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0PEJsb2NrY2hhaXJSZWNvcmRSZXNwb25zZTxCbG9ja2NoYWlyUmF3VHJhbnNhY3Rpb24+PihgL3Jhdy90cmFuc2FjdGlvbi8ke3R4aWR9YCkpLm1hcChcbiAgICAgIChib2R5KSA9PiB7XG4gICAgICAgIHJldHVybiB1bndyYXBSZWNvcmQoYm9keSwgdHhpZCkucmF3X3RyYW5zYWN0aW9uO1xuICAgICAgfVxuICAgICk7XG4gIH1cbn1cbiJdfQ==