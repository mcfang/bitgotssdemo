"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Enterprise = void 0;
/**
 * @prettier
 */
const _ = __importStar(require("lodash"));
const internal_1 = require("../internal");
const trading_1 = require("../trading");
const wallet_1 = require("../wallet");
const ecdsa_1 = require("../utils/tss/ecdsa");
const sdk_lib_mpc_1 = require("@bitgo/sdk-lib-mpc");
const ecdh_1 = require("../ecdh");
const buffer_1 = require("buffer");
class Enterprise {
    constructor(bitgo, baseCoin, enterpriseData) {
        this.bitgo = bitgo;
        this.baseCoin = baseCoin;
        if (!_.isObject(enterpriseData)) {
            throw new Error('enterpriseData has to be an object');
        }
        if (!_.isString(enterpriseData.id)) {
            throw new Error('enterprise id has to be a string');
        }
        if (!_.isString(enterpriseData.name)) {
            throw new Error('enterprise name has to be a string');
        }
        this._enterprise = enterpriseData;
        this.id = enterpriseData.id;
        this.name = enterpriseData.name;
    }
    /**
     * Enterprise URL for v1 methods, such as getting users
     * @param query
     */
    url(query = '') {
        return this.bitgo.url(`/enterprise/${this.id}${query}`);
    }
    /**
     * Enterprise URL for v2 methods, such as getting fee address balances
     * @param query
     */
    coinUrl(query = '') {
        return this.baseCoin.url(`/enterprise/${this.id}${query}`);
    }
    /**
     * Get the wallets associated with this Enterprise
     * @param params
     */
    async coinWallets(params = {}) {
        const walletData = (await this.bitgo.get(this.baseCoin.url('/wallet/enterprise/' + this.id)).result());
        walletData.wallets = walletData.wallets.map((w) => {
            return new wallet_1.Wallet(this.bitgo, this.baseCoin, w);
        });
        return walletData;
    }
    /**
     * Get the users associated with this Enterprise
     * @param params
     */
    async users(params = {}) {
        return await this.bitgo.get(this.url('/user')).result();
    }
    /**
     * Get the fee address balance for this Enterprise
     * @param params
     */
    async getFeeAddressBalance(params = {}) {
        return await this.bitgo.get(this.coinUrl('/feeAddressBalance')).result();
    }
    /**
     * Add a user to this Enterprise
     * @param params
     */
    async addUser(params = {}) {
        return await this.bitgo.post(this.url('/user')).send(params).result();
    }
    /**
     * Remove a user from this Enterprise
     * @param params
     */
    async removeUser(params = {}) {
        return await this.bitgo.del(this.url('/user')).send(params).result();
    }
    /**
     * Get the first pending transaction for this Enterprise
     * @param params
     */
    async getFirstPendingTransaction(params = {}) {
        return internal_1.getFirstPendingTransaction({ enterpriseId: this.id }, this.baseCoin, this.bitgo);
    }
    /**
     * Manage settlements for an enterprise
     */
    settlements() {
        return new trading_1.Settlements(this.bitgo, this.id);
    }
    /**
     * Manage affirmations for an enterprise
     */
    affirmations() {
        return new trading_1.Affirmations(this.bitgo, this.id);
    }
    /**
     * Verifies and signs bitgo proofs for the enterprise
     * @param userPassword - enterprise admin's login password
     */
    async verifyEcdsaBitGoChallengeProofs(userPassword) {
        return ecdsa_1.EcdsaUtils.getVerifyAndSignBitGoChallenges(this.bitgo, this.id, userPassword);
    }
    /**
     * Manages all the challenges and signatures and uploads them to enable
     * ECDSA signing on enterprise. Also generates a client side Ntilde challenge
     * if not provided, but note that can take approx. a minute.
     * @param userPassword
     * @param bitgoInstChallengeProofSignature
     * @param bitgoNitroChallengeProofSignature
     * @param challenge
     */
    async uploadAndEnableTssEcdsaSigning(userPassword, bitgoInstChallengeProofSignature, bitgoNitroChallengeProofSignature, challenge) {
        await ecdsa_1.EcdsaUtils.initiateChallengesForEnterprise(this.bitgo, this.id, userPassword, bitgoInstChallengeProofSignature, bitgoNitroChallengeProofSignature, challenge);
    }
    /**
     * Fetches the existing TSS ECDSA enterprise challenge if one exists.
     * Can be used with uploadAndEnableTssEcdsaSigning to re-sign the
     * enterprise challenge with new signatures.
     */
    async getExistingTssEcdsaChallenge() {
        var _a;
        const urlPath = `/enterprise/${this.id}/tssconfig`;
        const tssConfig = await this.bitgo.get(this.bitgo.url(urlPath, 2)).send().result();
        const enterpriseChallenge = (_a = tssConfig === null || tssConfig === void 0 ? void 0 : tssConfig.ecdsa.challenge) === null || _a === void 0 ? void 0 : _a.enterprise;
        if (!enterpriseChallenge) {
            throw new Error('No existing ECDSA challenge on the enterprise.');
        }
        if (!enterpriseChallenge.ntildeProof) {
            throw new Error('Existing ECDSA challenge does not have a proof. Please contact your enterprise admin to set this up.');
        }
        return sdk_lib_mpc_1.EcdsaTypes.deserializeNtildeWithProofs({
            ntilde: enterpriseChallenge.ntilde,
            h1: enterpriseChallenge.h1,
            h2: enterpriseChallenge.h2,
            ntildeProof: enterpriseChallenge.ntildeProof,
        });
    }
    /**
     * Resigns the enterprise and bitgo challenges with a new ECDH keychain.
     * Verifies that the old keychain signed the challenges previously.
     * @param oldEcdhKeypair - the old keychain that signed the challenges
     * @param newEcdhKeypair - the new keychain that will sign the challenges
     * @param entChallenge - existing signed enterprise challenge
     * @param bitgoInstChallenge - existing signed bitgo institutional challenge
     * @param bitgoNitroChallenge - existing signed bitgo nitro challenge
     */
    async resignEnterpriseChallenges(oldEcdhKeypair, newEcdhKeypair, entChallenge, bitgoInstChallenge, bitgoNitroChallenge) {
        // Verify all the challenges were signed by the old keypair
        if (!ecdh_1.verifyEcdhSignature(ecdsa_1.EcdsaUtils.getMessageToSignFromChallenge(entChallenge), entChallenge.verifiers.adminSignature, buffer_1.Buffer.from(oldEcdhKeypair.derivedPubKey, 'hex'))) {
            throw new Error(`Cannot re-sign. The Enterprise TSS config was signed by another user.`);
        }
        if (!ecdh_1.verifyEcdhSignature(ecdsa_1.EcdsaUtils.getMessageToSignFromChallenge(bitgoInstChallenge), bitgoInstChallenge.verifiers.adminSignature, buffer_1.Buffer.from(oldEcdhKeypair.derivedPubKey, 'hex'))) {
            throw new Error(`Cannot re-sign. The BitGo Institutional TSS config was signed by another user.`);
        }
        if (!ecdh_1.verifyEcdhSignature(ecdsa_1.EcdsaUtils.getMessageToSignFromChallenge(bitgoNitroChallenge), bitgoNitroChallenge.verifiers.adminSignature, buffer_1.Buffer.from(oldEcdhKeypair.derivedPubKey, 'hex'))) {
            throw new Error(`Cannot re-sign. The BitGo Nitro TSS config was signed by another user.`);
        }
        // Once all the challenges are verified, we can re-sign them with the new keypair.
        const signedEntChallenge = ecdsa_1.EcdsaUtils.signChallenge(entChallenge, newEcdhKeypair.xprv, newEcdhKeypair.derivationPath);
        const signedBitGoInstChallenge = ecdsa_1.EcdsaUtils.signChallenge(bitgoInstChallenge, newEcdhKeypair.xprv, newEcdhKeypair.derivationPath);
        const signedBitGoNitroChallenge = ecdsa_1.EcdsaUtils.signChallenge(bitgoNitroChallenge, newEcdhKeypair.xprv, newEcdhKeypair.derivationPath);
        await ecdsa_1.EcdsaUtils.uploadChallengesToEnterprise(this.bitgo, this.id, entChallenge, signedEntChallenge.toString('hex'), signedBitGoInstChallenge.toString('hex'), signedBitGoNitroChallenge.toString('hex'));
    }
    /**
     *  Check if the enterprise has a set of featureFlags
     * @param flags
     */
    hasFeatureFlags(flags) {
        return flags.every((targetFlag) => { var _a; return (_a = this._enterprise.featureFlags) === null || _a === void 0 ? void 0 : _a.includes(targetFlag); });
    }
}
exports.Enterprise = Enterprise;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50ZXJwcmlzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9iaXRnby9lbnRlcnByaXNlL2VudGVycHJpc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztHQUVHO0FBQ0gsMENBQTRCO0FBSTVCLDBDQUF5RDtBQUN6RCx3Q0FBdUQ7QUFDdkQsc0NBQW1DO0FBQ25DLDhDQUFxRztBQUNyRyxvREFBZ0Q7QUFDaEQsa0NBQThDO0FBQzlDLG1DQUFnQztBQUdoQyxNQUFhLFVBQVU7SUFPckIsWUFBWSxLQUFnQixFQUFFLFFBQW1CLEVBQUUsY0FBOEI7UUFDL0UsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDekIsSUFBSSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLEVBQUU7WUFDL0IsTUFBTSxJQUFJLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO1NBQ3ZEO1FBQ0QsSUFBSSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxFQUFFO1lBQ2xDLE1BQU0sSUFBSSxLQUFLLENBQUMsa0NBQWtDLENBQUMsQ0FBQztTQUNyRDtRQUNELElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNwQyxNQUFNLElBQUksS0FBSyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7U0FDdkQ7UUFDRCxJQUFJLENBQUMsV0FBVyxHQUFHLGNBQWMsQ0FBQztRQUNsQyxJQUFJLENBQUMsRUFBRSxHQUFHLGNBQWMsQ0FBQyxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLElBQUksR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDO0lBQ2xDLENBQUM7SUFFRDs7O09BR0c7SUFDSCxHQUFHLENBQUMsS0FBSyxHQUFHLEVBQUU7UUFD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QWMsQ0FDOUIsQ0FBQztRQUNGLE1BQU0sd0JBQXdCLEdBQUcsa0JBQVUsQ0FBQyxhQUFhLENBQ3ZELGtCQUFrQixFQUNsQixjQUFjLENBQUMsSUFBSSxFQUNuQixjQUFjLENBQUMsY0FBYyxDQUM5QixDQUFDO1FBQ0YsTUFBTSx5QkFBeUIsR0FBRyxrQkFBVSxDQUFDLGFBQWEsQ0FDeEQsbUJBQW1CLEVBQ25CLGNBQWMsQ0FBQyxJQUFJLEVBQ25CLGNBQWMsQ0FBQyxjQUFjLENBQzlCLENBQUM7UUFDRixNQUFNLGtCQUFVLENBQUMsNEJBQTRCLENBQzNDLElBQUksQ0FBQyxLQUFLLEVBQ1YsSUFBSSxDQUFDLEVBQUUsRUFDUCxZQUFZLEVBQ1osa0JBQWtCLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUNsQyx3QkFBd0IsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQ3hDLHlCQUF5QixDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FDMUMsQ0FBQztJQUNKLENBQUM7SUFFRDs7O09BR0c7SUFDSCxlQUFlLENBQUMsS0FBOEI7UUFDNUMsT0FBTyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsVUFBVSxFQUFFLEVBQUUsV0FBQyxPQUFBLE1BQUEsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLDBDQUFFLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQSxFQUFBLENBQUMsQ0FBQztJQUMxRixDQUFDO0NBQ0Y7QUFsUEQsZ0NBa1BDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAcHJldHRpZXJcbiAqL1xuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgSUJhc2VDb2luIH0gZnJvbSAnLi4vYmFzZUNvaW4nO1xuaW1wb3J0IHsgQml0R29CYXNlIH0gZnJvbSAnLi4vYml0Z29CYXNlJztcbmltcG9ydCB7IEVudGVycHJpc2VEYXRhLCBFbnRlcnByaXNlRmVhdHVyZUZsYWcsIElFbnRlcnByaXNlIH0gZnJvbSAnLi4vZW50ZXJwcmlzZSc7XG5pbXBvcnQgeyBnZXRGaXJzdFBlbmRpbmdUcmFuc2FjdGlvbiB9IGZyb20gJy4uL2ludGVybmFsJztcbmltcG9ydCB7IEFmZmlybWF0aW9ucywgU2V0dGxlbWVudHMgfSBmcm9tICcuLi90cmFkaW5nJztcbmltcG9ydCB7IFdhbGxldCB9IGZyb20gJy4uL3dhbGxldCc7XG5pbXBvcnQgeyBCaXRHb1Byb29mU2lnbmF0dXJlcywgRWNkc2FVdGlscywgU2VyaWFsaXplZE50aWxkZVdpdGhWZXJpZmllcnMgfSBmcm9tICcuLi91dGlscy90c3MvZWNkc2EnO1xuaW1wb3J0IHsgRWNkc2FUeXBlcyB9IGZyb20gJ0BiaXRnby9zZGstbGliLW1wYyc7XG5pbXBvcnQgeyB2ZXJpZnlFY2RoU2lnbmF0dXJlIH0gZnJvbSAnLi4vZWNkaCc7XG5pbXBvcnQgeyBCdWZmZXIgfSBmcm9tICdidWZmZXInO1xuaW1wb3J0IHsgRWNkaERlcml2ZWRLZXlwYWlyIH0gZnJvbSAnLi4va2V5Y2hhaW4nO1xuXG5leHBvcnQgY2xhc3MgRW50ZXJwcmlzZSBpbXBsZW1lbnRzIElFbnRlcnByaXNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBiaXRnbzogQml0R29CYXNlO1xuICBwcml2YXRlIHJlYWRvbmx5IGJhc2VDb2luOiBJQmFzZUNvaW47XG4gIHB1YmxpYyByZWFkb25seSBpZDogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgX2VudGVycHJpc2U6IEVudGVycHJpc2VEYXRhO1xuXG4gIGNvbnN0cnVjdG9yKGJpdGdvOiBCaXRHb0Jhc2UsIGJhc2VDb2luOiBJQmFzZUNvaW4sIGVudGVycHJpc2VEYXRhOiBFbnRlcnByaXNlRGF0YSkge1xuICAgIHRoaXMuYml0Z28gPSBiaXRnbztcbiAgICB0aGlzLmJhc2VDb2luID0gYmFzZUNvaW47XG4gICAgaWYgKCFfLmlzT2JqZWN0KGVudGVycHJpc2VEYXRhKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdlbnRlcnByaXNlRGF0YSBoYXMgdG8gYmUgYW4gb2JqZWN0Jyk7XG4gICAgfVxuICAgIGlmICghXy5pc1N0cmluZyhlbnRlcnByaXNlRGF0YS5pZCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignZW50ZXJwcmlzZSBpZCBoYXMgdG8gYmUgYSBzdHJpbmcnKTtcbiAgICB9XG4gICAgaWYgKCFfLmlzU3RyaW5nKGVudGVycHJpc2VEYXRhLm5hbWUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2VudGVycHJpc2UgbmFtZSBoYXMgdG8gYmUgYSBzdHJpbmcnKTtcbiAgICB9XG4gICAgdGhpcy5fZW50ZXJwcmlzZSA9IGVudGVycHJpc2VEYXRhO1xuICAgIHRoaXMuaWQgPSBlbnRlcnByaXNlRGF0YS5pZDtcbiAgICB0aGlzLm5hbWUgPSBlbnRlcnByaXNlRGF0YS5uYW1lO1xuICB9XG5cbiAgLyoqXG4gICAqIEVudGVycHJpc2UgVVJMIGZvciB2MSBtZXRob2RzLCBzdWNoIGFzIGdldHRpbmcgdXNlcnNcbiAgICogQHBhcmFtIHF1ZXJ5XG4gICAqL1xuICB1cmwocXVlcnkgPSAnJyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuYml0Z28udXJsKGAvZW50ZXJwcmlzZS8ke3RoaXMuaWR9JHtxdWVyeX1gKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFbnRlcnByaXNlIFVSTCBmb3IgdjIgbWV0aG9kcywgc3VjaCBhcyBnZXR0aW5nIGZlZSBhZGRyZXNzIGJhbGFuY2VzXG4gICAqIEBwYXJhbSBxdWVyeVxuICAgKi9cbiAgY29pblVybChxdWVyeSA9ICcnKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5iYXNlQ29pbi51cmwoYC9lbnRlcnByaXNlLyR7dGhpcy5pZH0ke3F1ZXJ5fWApO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgd2FsbGV0cyBhc3NvY2lhdGVkIHdpdGggdGhpcyBFbnRlcnByaXNlXG4gICAqIEBwYXJhbSBwYXJhbXNcbiAgICovXG4gIGFzeW5jIGNvaW5XYWxsZXRzKHBhcmFtczogUmVjb3JkPHN0cmluZywgbmV2ZXI+ID0ge30pOiBQcm9taXNlPFdhbGxldFtdPiB7XG4gICAgY29uc3Qgd2FsbGV0RGF0YSA9IChhd2FpdCB0aGlzLmJpdGdvLmdldCh0aGlzLmJhc2VDb2luLnVybCgnL3dhbGxldC9lbnRlcnByaXNlLycgKyB0aGlzLmlkKSkucmVzdWx0KCkpIGFzIGFueTtcbiAgICB3YWxsZXREYXRhLndhbGxldHMgPSB3YWxsZXREYXRhLndhbGxldHMubWFwKCh3KSA9PiB7XG4gICAgICByZXR1cm4gbmV3IFdhbGxldCh0aGlzLmJpdGdvLCB0aGlzLmJhc2VDb2luLCB3KTtcbiAgICB9KTtcbiAgICByZXR1cm4gd2FsbGV0RGF0YTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIHVzZXJzIGFzc29jaWF0ZWQgd2l0aCB0aGlzIEVudGVycHJpc2VcbiAgICogQHBhcmFtIHBhcmFtc1xuICAgKi9cbiAgYXN5bmMgdXNlcnMocGFyYW1zOiBSZWNvcmQ8c3RyaW5nLCBuZXZlcj4gPSB7fSk6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuYml0Z28uZ2V0KHRoaXMudXJsKCcvdXNlcicpKS5yZXN1bHQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGZlZSBhZGRyZXNzIGJhbGFuY2UgZm9yIHRoaXMgRW50ZXJwcmlzZVxuICAgKiBAcGFyYW0gcGFyYW1zXG4gICAqL1xuICBhc3luYyBnZXRGZWVBZGRyZXNzQmFsYW5jZShwYXJhbXM6IFJlY29yZDxzdHJpbmcsIG5ldmVyPiA9IHt9KTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5iaXRnby5nZXQodGhpcy5jb2luVXJsKCcvZmVlQWRkcmVzc0JhbGFuY2UnKSkucmVzdWx0KCk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGEgdXNlciB0byB0aGlzIEVudGVycHJpc2VcbiAgICogQHBhcmFtIHBhcmFtc1xuICAgKi9cbiAgYXN5bmMgYWRkVXNlcihwYXJhbXM6IGFueSA9IHt9KTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5iaXRnby5wb3N0KHRoaXMudXJsKCcvdXNlcicpKS5zZW5kKHBhcmFtcykucmVzdWx0KCk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIGEgdXNlciBmcm9tIHRoaXMgRW50ZXJwcmlzZVxuICAgKiBAcGFyYW0gcGFyYW1zXG4gICAqL1xuICBhc3luYyByZW1vdmVVc2VyKHBhcmFtczogYW55ID0ge30pOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmJpdGdvLmRlbCh0aGlzLnVybCgnL3VzZXInKSkuc2VuZChwYXJhbXMpLnJlc3VsdCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgZmlyc3QgcGVuZGluZyB0cmFuc2FjdGlvbiBmb3IgdGhpcyBFbnRlcnByaXNlXG4gICAqIEBwYXJhbSBwYXJhbXNcbiAgICovXG4gIGFzeW5jIGdldEZpcnN0UGVuZGluZ1RyYW5zYWN0aW9uKHBhcmFtczogUmVjb3JkPHN0cmluZywgbmV2ZXI+ID0ge30pOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiBnZXRGaXJzdFBlbmRpbmdUcmFuc2FjdGlvbih7IGVudGVycHJpc2VJZDogdGhpcy5pZCB9LCB0aGlzLmJhc2VDb2luLCB0aGlzLmJpdGdvKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNYW5hZ2Ugc2V0dGxlbWVudHMgZm9yIGFuIGVudGVycHJpc2VcbiAgICovXG4gIHNldHRsZW1lbnRzKCk6IFNldHRsZW1lbnRzIHtcbiAgICByZXR1cm4gbmV3IFNldHRsZW1lbnRzKHRoaXMuYml0Z28sIHRoaXMuaWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIE1hbmFnZSBhZmZpcm1hdGlvbnMgZm9yIGFuIGVudGVycHJpc2VcbiAgICovXG4gIGFmZmlybWF0aW9ucygpOiBBZmZpcm1hdGlvbnMge1xuICAgIHJldHVybiBuZXcgQWZmaXJtYXRpb25zKHRoaXMuYml0Z28sIHRoaXMuaWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWVzIGFuZCBzaWducyBiaXRnbyBwcm9vZnMgZm9yIHRoZSBlbnRlcnByaXNlXG4gICAqIEBwYXJhbSB1c2VyUGFzc3dvcmQgLSBlbnRlcnByaXNlIGFkbWluJ3MgbG9naW4gcGFzc3dvcmRcbiAgICovXG4gIGFzeW5jIHZlcmlmeUVjZHNhQml0R29DaGFsbGVuZ2VQcm9vZnModXNlclBhc3N3b3JkOiBzdHJpbmcpOiBQcm9taXNlPEJpdEdvUHJvb2ZTaWduYXR1cmVzPiB7XG4gICAgcmV0dXJuIEVjZHNhVXRpbHMuZ2V0VmVyaWZ5QW5kU2lnbkJpdEdvQ2hhbGxlbmdlcyh0aGlzLmJpdGdvLCB0aGlzLmlkLCB1c2VyUGFzc3dvcmQpO1xuICB9XG5cbiAgLyoqXG4gICAqIE1hbmFnZXMgYWxsIHRoZSBjaGFsbGVuZ2VzIGFuZCBzaWduYXR1cmVzIGFuZCB1cGxvYWRzIHRoZW0gdG8gZW5hYmxlXG4gICAqIEVDRFNBIHNpZ25pbmcgb24gZW50ZXJwcmlzZS4gQWxzbyBnZW5lcmF0ZXMgYSBjbGllbnQgc2lkZSBOdGlsZGUgY2hhbGxlbmdlXG4gICAqIGlmIG5vdCBwcm92aWRlZCwgYnV0IG5vdGUgdGhhdCBjYW4gdGFrZSBhcHByb3guIGEgbWludXRlLlxuICAgKiBAcGFyYW0gdXNlclBhc3N3b3JkXG4gICAqIEBwYXJhbSBiaXRnb0luc3RDaGFsbGVuZ2VQcm9vZlNpZ25hdHVyZVxuICAgKiBAcGFyYW0gYml0Z29OaXRyb0NoYWxsZW5nZVByb29mU2lnbmF0dXJlXG4gICAqIEBwYXJhbSBjaGFsbGVuZ2VcbiAgICovXG4gIGFzeW5jIHVwbG9hZEFuZEVuYWJsZVRzc0VjZHNhU2lnbmluZyhcbiAgICB1c2VyUGFzc3dvcmQ6IHN0cmluZyxcbiAgICBiaXRnb0luc3RDaGFsbGVuZ2VQcm9vZlNpZ25hdHVyZTogQnVmZmVyLFxuICAgIGJpdGdvTml0cm9DaGFsbGVuZ2VQcm9vZlNpZ25hdHVyZTogQnVmZmVyLFxuICAgIGNoYWxsZW5nZT86IEVjZHNhVHlwZXMuRGVzZXJpYWxpemVkTnRpbGRlV2l0aFByb29mc1xuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCBFY2RzYVV0aWxzLmluaXRpYXRlQ2hhbGxlbmdlc0ZvckVudGVycHJpc2UoXG4gICAgICB0aGlzLmJpdGdvLFxuICAgICAgdGhpcy5pZCxcbiAgICAgIHVzZXJQYXNzd29yZCxcbiAgICAgIGJpdGdvSW5zdENoYWxsZW5nZVByb29mU2lnbmF0dXJlLFxuICAgICAgYml0Z29OaXRyb0NoYWxsZW5nZVByb29mU2lnbmF0dXJlLFxuICAgICAgY2hhbGxlbmdlXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGZXRjaGVzIHRoZSBleGlzdGluZyBUU1MgRUNEU0EgZW50ZXJwcmlzZSBjaGFsbGVuZ2UgaWYgb25lIGV4aXN0cy5cbiAgICogQ2FuIGJlIHVzZWQgd2l0aCB1cGxvYWRBbmRFbmFibGVUc3NFY2RzYVNpZ25pbmcgdG8gcmUtc2lnbiB0aGVcbiAgICogZW50ZXJwcmlzZSBjaGFsbGVuZ2Ugd2l0aCBuZXcgc2lnbmF0dXJlcy5cbiAgICovXG4gIGFzeW5jIGdldEV4aXN0aW5nVHNzRWNkc2FDaGFsbGVuZ2UoKTogUHJvbWlzZTxFY2RzYVR5cGVzLkRlc2VyaWFsaXplZE50aWxkZVdpdGhQcm9vZnM+IHtcbiAgICBjb25zdCB1cmxQYXRoID0gYC9lbnRlcnByaXNlLyR7dGhpcy5pZH0vdHNzY29uZmlnYDtcbiAgICBjb25zdCB0c3NDb25maWcgPSBhd2FpdCB0aGlzLmJpdGdvLmdldCh0aGlzLmJpdGdvLnVybCh1cmxQYXRoLCAyKSkuc2VuZCgpLnJlc3VsdCgpO1xuICAgIGNvbnN0IGVudGVycHJpc2VDaGFsbGVuZ2UgPSB0c3NDb25maWc/LmVjZHNhLmNoYWxsZW5nZT8uZW50ZXJwcmlzZTtcbiAgICBpZiAoIWVudGVycHJpc2VDaGFsbGVuZ2UpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gZXhpc3RpbmcgRUNEU0EgY2hhbGxlbmdlIG9uIHRoZSBlbnRlcnByaXNlLicpO1xuICAgIH1cbiAgICBpZiAoIWVudGVycHJpc2VDaGFsbGVuZ2UubnRpbGRlUHJvb2YpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0V4aXN0aW5nIEVDRFNBIGNoYWxsZW5nZSBkb2VzIG5vdCBoYXZlIGEgcHJvb2YuIFBsZWFzZSBjb250YWN0IHlvdXIgZW50ZXJwcmlzZSBhZG1pbiB0byBzZXQgdGhpcyB1cC4nXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gRWNkc2FUeXBlcy5kZXNlcmlhbGl6ZU50aWxkZVdpdGhQcm9vZnMoe1xuICAgICAgbnRpbGRlOiBlbnRlcnByaXNlQ2hhbGxlbmdlLm50aWxkZSxcbiAgICAgIGgxOiBlbnRlcnByaXNlQ2hhbGxlbmdlLmgxLFxuICAgICAgaDI6IGVudGVycHJpc2VDaGFsbGVuZ2UuaDIsXG4gICAgICBudGlsZGVQcm9vZjogZW50ZXJwcmlzZUNoYWxsZW5nZS5udGlsZGVQcm9vZixcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNpZ25zIHRoZSBlbnRlcnByaXNlIGFuZCBiaXRnbyBjaGFsbGVuZ2VzIHdpdGggYSBuZXcgRUNESCBrZXljaGFpbi5cbiAgICogVmVyaWZpZXMgdGhhdCB0aGUgb2xkIGtleWNoYWluIHNpZ25lZCB0aGUgY2hhbGxlbmdlcyBwcmV2aW91c2x5LlxuICAgKiBAcGFyYW0gb2xkRWNkaEtleXBhaXIgLSB0aGUgb2xkIGtleWNoYWluIHRoYXQgc2lnbmVkIHRoZSBjaGFsbGVuZ2VzXG4gICAqIEBwYXJhbSBuZXdFY2RoS2V5cGFpciAtIHRoZSBuZXcga2V5Y2hhaW4gdGhhdCB3aWxsIHNpZ24gdGhlIGNoYWxsZW5nZXNcbiAgICogQHBhcmFtIGVudENoYWxsZW5nZSAtIGV4aXN0aW5nIHNpZ25lZCBlbnRlcnByaXNlIGNoYWxsZW5nZVxuICAgKiBAcGFyYW0gYml0Z29JbnN0Q2hhbGxlbmdlIC0gZXhpc3Rpbmcgc2lnbmVkIGJpdGdvIGluc3RpdHV0aW9uYWwgY2hhbGxlbmdlXG4gICAqIEBwYXJhbSBiaXRnb05pdHJvQ2hhbGxlbmdlIC0gZXhpc3Rpbmcgc2lnbmVkIGJpdGdvIG5pdHJvIGNoYWxsZW5nZVxuICAgKi9cbiAgYXN5bmMgcmVzaWduRW50ZXJwcmlzZUNoYWxsZW5nZXMoXG4gICAgb2xkRWNkaEtleXBhaXI6IEVjZGhEZXJpdmVkS2V5cGFpcixcbiAgICBuZXdFY2RoS2V5cGFpcjogRWNkaERlcml2ZWRLZXlwYWlyLFxuICAgIGVudENoYWxsZW5nZTogU2VyaWFsaXplZE50aWxkZVdpdGhWZXJpZmllcnMsXG4gICAgYml0Z29JbnN0Q2hhbGxlbmdlOiBTZXJpYWxpemVkTnRpbGRlV2l0aFZlcmlmaWVycyxcbiAgICBiaXRnb05pdHJvQ2hhbGxlbmdlOiBTZXJpYWxpemVkTnRpbGRlV2l0aFZlcmlmaWVyc1xuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBWZXJpZnkgYWxsIHRoZSBjaGFsbGVuZ2VzIHdlcmUgc2lnbmVkIGJ5IHRoZSBvbGQga2V5cGFpclxuICAgIGlmIChcbiAgICAgICF2ZXJpZnlFY2RoU2lnbmF0dXJlKFxuICAgICAgICBFY2RzYVV0aWxzLmdldE1lc3NhZ2VUb1NpZ25Gcm9tQ2hhbGxlbmdlKGVudENoYWxsZW5nZSksXG4gICAgICAgIGVudENoYWxsZW5nZS52ZXJpZmllcnMuYWRtaW5TaWduYXR1cmUsXG4gICAgICAgIEJ1ZmZlci5mcm9tKG9sZEVjZGhLZXlwYWlyLmRlcml2ZWRQdWJLZXksICdoZXgnKVxuICAgICAgKVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcmUtc2lnbi4gVGhlIEVudGVycHJpc2UgVFNTIGNvbmZpZyB3YXMgc2lnbmVkIGJ5IGFub3RoZXIgdXNlci5gKTtcbiAgICB9XG4gICAgaWYgKFxuICAgICAgIXZlcmlmeUVjZGhTaWduYXR1cmUoXG4gICAgICAgIEVjZHNhVXRpbHMuZ2V0TWVzc2FnZVRvU2lnbkZyb21DaGFsbGVuZ2UoYml0Z29JbnN0Q2hhbGxlbmdlKSxcbiAgICAgICAgYml0Z29JbnN0Q2hhbGxlbmdlLnZlcmlmaWVycy5hZG1pblNpZ25hdHVyZSxcbiAgICAgICAgQnVmZmVyLmZyb20ob2xkRWNkaEtleXBhaXIuZGVyaXZlZFB1YktleSwgJ2hleCcpXG4gICAgICApXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCByZS1zaWduLiBUaGUgQml0R28gSW5zdGl0dXRpb25hbCBUU1MgY29uZmlnIHdhcyBzaWduZWQgYnkgYW5vdGhlciB1c2VyLmApO1xuICAgIH1cbiAgICBpZiAoXG4gICAgICAhdmVyaWZ5RWNkaFNpZ25hdHVyZShcbiAgICAgICAgRWNkc2FVdGlscy5nZXRNZXNzYWdlVG9TaWduRnJvbUNoYWxsZW5nZShiaXRnb05pdHJvQ2hhbGxlbmdlKSxcbiAgICAgICAgYml0Z29OaXRyb0NoYWxsZW5nZS52ZXJpZmllcnMuYWRtaW5TaWduYXR1cmUsXG4gICAgICAgIEJ1ZmZlci5mcm9tKG9sZEVjZGhLZXlwYWlyLmRlcml2ZWRQdWJLZXksICdoZXgnKVxuICAgICAgKVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcmUtc2lnbi4gVGhlIEJpdEdvIE5pdHJvIFRTUyBjb25maWcgd2FzIHNpZ25lZCBieSBhbm90aGVyIHVzZXIuYCk7XG4gICAgfVxuXG4gICAgLy8gT25jZSBhbGwgdGhlIGNoYWxsZW5nZXMgYXJlIHZlcmlmaWVkLCB3ZSBjYW4gcmUtc2lnbiB0aGVtIHdpdGggdGhlIG5ldyBrZXlwYWlyLlxuICAgIGNvbnN0IHNpZ25lZEVudENoYWxsZW5nZSA9IEVjZHNhVXRpbHMuc2lnbkNoYWxsZW5nZShcbiAgICAgIGVudENoYWxsZW5nZSxcbiAgICAgIG5ld0VjZGhLZXlwYWlyLnhwcnYsXG4gICAgICBuZXdFY2RoS2V5cGFpci5kZXJpdmF0aW9uUGF0aFxuICAgICk7XG4gICAgY29uc3Qgc2lnbmVkQml0R29JbnN0Q2hhbGxlbmdlID0gRWNkc2FVdGlscy5zaWduQ2hhbGxlbmdlKFxuICAgICAgYml0Z29JbnN0Q2hhbGxlbmdlLFxuICAgICAgbmV3RWNkaEtleXBhaXIueHBydixcbiAgICAgIG5ld0VjZGhLZXlwYWlyLmRlcml2YXRpb25QYXRoXG4gICAgKTtcbiAgICBjb25zdCBzaWduZWRCaXRHb05pdHJvQ2hhbGxlbmdlID0gRWNkc2FVdGlscy5zaWduQ2hhbGxlbmdlKFxuICAgICAgYml0Z29OaXRyb0NoYWxsZW5nZSxcbiAgICAgIG5ld0VjZGhLZXlwYWlyLnhwcnYsXG4gICAgICBuZXdFY2RoS2V5cGFpci5kZXJpdmF0aW9uUGF0aFxuICAgICk7XG4gICAgYXdhaXQgRWNkc2FVdGlscy51cGxvYWRDaGFsbGVuZ2VzVG9FbnRlcnByaXNlKFxuICAgICAgdGhpcy5iaXRnbyxcbiAgICAgIHRoaXMuaWQsXG4gICAgICBlbnRDaGFsbGVuZ2UsXG4gICAgICBzaWduZWRFbnRDaGFsbGVuZ2UudG9TdHJpbmcoJ2hleCcpLFxuICAgICAgc2lnbmVkQml0R29JbnN0Q2hhbGxlbmdlLnRvU3RyaW5nKCdoZXgnKSxcbiAgICAgIHNpZ25lZEJpdEdvTml0cm9DaGFsbGVuZ2UudG9TdHJpbmcoJ2hleCcpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiAgQ2hlY2sgaWYgdGhlIGVudGVycHJpc2UgaGFzIGEgc2V0IG9mIGZlYXR1cmVGbGFnc1xuICAgKiBAcGFyYW0gZmxhZ3NcbiAgICovXG4gIGhhc0ZlYXR1cmVGbGFncyhmbGFnczogRW50ZXJwcmlzZUZlYXR1cmVGbGFnW10pOiBib29sZWFuIHtcbiAgICByZXR1cm4gZmxhZ3MuZXZlcnkoKHRhcmdldEZsYWcpID0+IHRoaXMuX2VudGVycHJpc2UuZmVhdHVyZUZsYWdzPy5pbmNsdWRlcyh0YXJnZXRGbGFnKSk7XG4gIH1cbn1cbiJdfQ==