"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TransactionBuilder = void 0;
const sdk_core_1 = require("@bitgo/sdk-core");
const bignumber_js_1 = __importDefault(require("bignumber.js"));
const keyPair_1 = require("./keyPair");
const multisigUtils_1 = require("./multisigUtils");
const transaction_1 = require("./transaction");
const transferBuilder_1 = require("./transferBuilder");
const utils_1 = require("./utils");
const DEFAULT_M = 3;
/**
 * Tezos transaction builder.
 */
class TransactionBuilder extends sdk_core_1.BaseTransactionBuilder {
    /**
     * Public constructor.
     *
     * @param {CoinConfig} _coinConfig - coin configuration
     */
    constructor(_coinConfig) {
        super(_coinConfig);
        this._type = sdk_core_1.TransactionType.Send;
        this._counter = new bignumber_js_1.default(0);
        this._transfers = [];
        this._walletOwnerPublicKeys = [];
        this._multisigSignerKeyPairs = [];
        this._dataToSignOverride = [];
        this.transaction = new transaction_1.Transaction(_coinConfig);
    }
    // region Base Builder
    /** @inheritdoc */
    fromImplementation(rawTransaction) {
        // Decoding the transaction is an async operation, so save it and leave the decoding for the
        // build step
        this._serializedTransaction = rawTransaction;
        return new transaction_1.Transaction(this._coinConfig);
    }
    /** @inheritdoc */
    signImplementation(key) {
        const signer = new keyPair_1.KeyPair({ prv: key.key });
        // Currently public key revelation is the only type of account update tx supported in Tezos
        if (this._type === sdk_core_1.TransactionType.AccountUpdate && !this._publicKeyToReveal) {
            throw new sdk_core_1.SigningError('Cannot sign a public key revelation transaction without public key');
        }
        if (this._type === sdk_core_1.TransactionType.WalletInitialization && this._walletOwnerPublicKeys.length === 0) {
            throw new sdk_core_1.SigningError('Cannot sign an wallet initialization transaction without owners');
        }
        if (this._type === sdk_core_1.TransactionType.Send &&
            this._transfers.length === 0 &&
            this._serializedTransaction === undefined) {
            throw new sdk_core_1.SigningError('Cannot sign an empty send transaction');
        }
        if (this._type === sdk_core_1.TransactionType.Send && (!this._sourceAddress || this._sourceAddress !== signer.getAddress())) {
            // If the signer is not the source and it is a send transaction, add it to the list of
            // multisig wallet signers
            // TODO: support a combination of keys with and without custom index
            if (key.index && key.index >= DEFAULT_M) {
                throw new sdk_core_1.BuildTransactionError('Custom index cannot be greater than the wallet total number of signers (owners)');
            }
            // Make sure either all keys passed have a custom index or none of them have
            const shouldHaveCustomIndex = key.hasOwnProperty('index');
            for (let i = 0; i < this._multisigSignerKeyPairs.length; i++) {
                if (shouldHaveCustomIndex !== (this._multisigSignerKeyPairs[i].index !== undefined)) {
                    throw new sdk_core_1.BuildTransactionError('Custom index has to be set for all multisig contract signing keys or none');
                }
            }
            const multisigSignerKey = shouldHaveCustomIndex ? { key: signer, index: key.index } : { key: signer };
            this._multisigSignerKeyPairs.push(multisigSignerKey);
        }
        else {
            if (this._sourceKeyPair) {
                throw new sdk_core_1.SigningError('Cannot sign multiple times a non send-type transaction');
            }
            this._sourceKeyPair = signer;
        }
        // Signing the transaction is an async operation, so save the source and leave the actual
        // signing for the build step
        return this.transaction;
    }
    /** @inheritdoc */
    async buildImplementation() {
        // If the from() method was called, use the serialized transaction as a base
        if (this._serializedTransaction) {
            await this.transaction.initFromSerializedTransaction(this._serializedTransaction);
            for (let i = 0; i < this._dataToSignOverride.length; i++) {
                const signatures = await this.getSignatures(this._dataToSignOverride[i].dataToSign);
                await this.transaction.addTransferSignature(signatures, this._dataToSignOverride[i].index || i);
            }
            // TODO: make changes to the transaction if any extra parameter has been set then sign it
        }
        else {
            let contents = [];
            switch (this._type) {
                case sdk_core_1.TransactionType.AccountUpdate:
                    if (this._publicKeyToReveal) {
                        contents.push(this.buildPublicKeyRevelationOperation());
                    }
                    break;
                case sdk_core_1.TransactionType.WalletInitialization:
                    if (this._publicKeyToReveal) {
                        contents.push(this.buildPublicKeyRevelationOperation());
                    }
                    contents.push(this.buildWalletInitializationOperations());
                    break;
                case sdk_core_1.TransactionType.Send:
                    if (this._publicKeyToReveal) {
                        contents.push(this.buildPublicKeyRevelationOperation());
                    }
                    contents = contents.concat(await this.buildSendTransactionContent());
                    break;
                case sdk_core_1.TransactionType.AddressInitialization:
                    if (this._publicKeyToReveal) {
                        contents.push(this.buildPublicKeyRevelationOperation());
                    }
                    contents = contents.concat(this.buildForwarderDeploymentContent());
                    break;
                case sdk_core_1.TransactionType.SingleSigSend:
                    // No support for revelation txns as primary use case is to send from fee address
                    contents = contents.concat(await this.buildSendTransactionContent());
                    break;
                default:
                    throw new sdk_core_1.BuildTransactionError('Unsupported transaction type');
            }
            if (contents.length === 0) {
                throw new sdk_core_1.BuildTransactionError('Empty transaction');
            }
            const parsedTransaction = {
                branch: this._blockHeader,
                contents,
            };
            this.transaction = new transaction_1.Transaction(this._coinConfig);
            // Build and sign a new transaction based on the latest changes
            await this.transaction.initFromParsedTransaction(parsedTransaction);
        }
        if (this._sourceKeyPair && this._sourceKeyPair.getKeys().prv) {
            // TODO: check if there are more signers than needed for a singlesig or multisig transaction
            await this.transaction.sign(this._sourceKeyPair);
        }
        return this.transaction;
    }
    // endregion
    // region Common builder methods
    /**
     * Set the transaction branch id.
     *
     * @param {string} blockId A block hash to use as branch reference
     */
    branch(blockId) {
        if (!utils_1.isValidBlockHash(blockId)) {
            throw new sdk_core_1.BuildTransactionError('Invalid block hash ' + blockId);
        }
        this._blockHeader = blockId;
    }
    /**
     * The type of transaction being built.
     *
     * @param {TransactionType} type - type of the transaction
     */
    type(type) {
        if (type === sdk_core_1.TransactionType.Send && this._walletOwnerPublicKeys.length > 0) {
            throw new sdk_core_1.BuildTransactionError('Transaction cannot be labeled as Send when owners have already been set');
        }
        if (type !== sdk_core_1.TransactionType.Send && this._transfers.length > 0) {
            throw new sdk_core_1.BuildTransactionError('Transaction contains transfers and can only be labeled as Send');
        }
        this._type = type;
    }
    /**
     * Set the transaction fees. Low fees may get a transaction rejected or never picked up by bakers.
     *
     * @param {Fee} fee Baker fees. May also include the maximum gas and storage fees to pay
     */
    fee(fee) {
        this.validateValue(new bignumber_js_1.default(fee.fee));
        if (fee.gasLimit) {
            this.validateValue(new bignumber_js_1.default(fee.gasLimit));
        }
        if (fee.storageLimit) {
            this.validateValue(new bignumber_js_1.default(fee.storageLimit));
        }
        this._fee = fee;
    }
    /**
     * Set the transaction initiator. This account will pay for the transaction fees, but it will not
     * be added as an owner of a wallet in a init transaction, unless manually set as one of the
     * owners.
     *
     * @param {string} source A Tezos address
     */
    source(source) {
        this.validateAddress({ address: source });
        this._sourceAddress = source;
    }
    /**
     * Set an amount of mutez to transfer in this transaction this transaction. This is different than
     * the amount to transfer from a multisig wallet.
     *
     * @param {string} amount Amount in mutez (1/1000000 Tezies)
     */
    initialBalance(amount) {
        if (this._type !== sdk_core_1.TransactionType.WalletInitialization) {
            throw new sdk_core_1.BuildTransactionError('Initial balance can only be set for wallet initialization transactions');
        }
        this.validateValue(new bignumber_js_1.default(amount));
        this._initialBalance = amount;
    }
    /**
     * Set the transaction counter to prevent submitting repeated transactions.
     *
     * @param {string} counter The counter to use
     */
    counter(counter) {
        this._counter = new bignumber_js_1.default(counter);
    }
    /**
     * Set the destination address of a forwarder contract
     * Used in forwarder contract deployment as destination address
     *
     * @param {string} contractAddress - contract address to use
     */
    forwarderDestination(contractAddress) {
        if (this._type !== sdk_core_1.TransactionType.AddressInitialization) {
            throw new sdk_core_1.BuildTransactionError('Forwarder destination can only be set for address initialization transactions');
        }
        if (!utils_1.isValidOriginatedAddress(contractAddress)) {
            throw new sdk_core_1.BuildTransactionError('Forwarder destination can only be an originated address');
        }
        this._forwarderDestination = contractAddress;
    }
    // endregion
    // region PublicKeyRevelation builder methods
    /**
     * The public key to reveal.
     *
     * @param {string} publicKey A Tezos public key
     */
    publicKeyToReveal(publicKey) {
        if (this._publicKeyToReveal) {
            throw new sdk_core_1.BuildTransactionError('Public key to reveal already set: ' + this._publicKeyToReveal);
        }
        const keyPair = new keyPair_1.KeyPair({ pub: publicKey });
        if (keyPair.getAddress() !== this._sourceAddress) {
            throw new sdk_core_1.BuildTransactionError('Public key does not match the source address: ' + this._sourceAddress);
        }
        this._publicKeyToReveal = keyPair.getKeys().pub;
    }
    /**
     * Build a reveal operation for the source account with default fees.
     *
     * @returns {RevealOp} A Tezos reveal operation
     */
    buildPublicKeyRevelationOperation() {
        const operation = multisigUtils_1.revealOperation(this._counter.toString(), this._sourceAddress, this._publicKeyToReveal);
        this._counter = this._counter.plus(1);
        return operation;
    }
    // endregion
    // region WalletInitialization builder methods
    /**
     * Set one of the owners of the multisig wallet.
     *
     * @param {string} publicKey A Tezos public key
     */
    owner(publicKey) {
        if (this._type !== sdk_core_1.TransactionType.WalletInitialization) {
            throw new sdk_core_1.BuildTransactionError('Multisig wallet owner can only be set for initialization transactions');
        }
        if (this._walletOwnerPublicKeys.length >= DEFAULT_M) {
            throw new sdk_core_1.BuildTransactionError('A maximum of ' + DEFAULT_M + ' owners can be set for a multisig wallet');
        }
        if (!utils_1.isValidPublicKey(publicKey)) {
            throw new sdk_core_1.BuildTransactionError('Invalid public key: ' + publicKey);
        }
        if (this._walletOwnerPublicKeys.includes(publicKey)) {
            throw new sdk_core_1.BuildTransactionError('Repeated owner public key: ' + publicKey);
        }
        this._walletOwnerPublicKeys.push(publicKey);
    }
    /**
     * Set an initial delegate to initialize this wallet to. This is different than the delegation to
     * set while doing a separate delegation transaction.
     *
     * @param {string} delegate The address to delegate the funds to
     */
    initialDelegate(delegate) {
        if (this._type !== sdk_core_1.TransactionType.WalletInitialization) {
            throw new sdk_core_1.BuildTransactionError('Initial delegation can only be set for wallet initialization transactions');
        }
        this.validateAddress({ address: delegate });
        this._initialDelegate = delegate;
    }
    /**
     * Build an origination operation for a generic multisig contract.
     *
     * @returns {Operation} A Tezos origination operation
     */
    buildWalletInitializationOperations() {
        const originationOp = multisigUtils_1.genericMultisigOriginationOperation(this._counter.toString(), this._sourceAddress, this._fee.fee, this._fee.gasLimit || utils_1.DEFAULT_GAS_LIMIT.ORIGINATION.toString(), this._fee.storageLimit || utils_1.DEFAULT_STORAGE_LIMIT.ORIGINATION.toString(), this._initialBalance || '0', this._walletOwnerPublicKeys, this._initialDelegate);
        this._counter = this._counter.plus(1);
        return originationOp;
    }
    // endregion
    // region Send builder methods
    /**
     * Initialize a new TransferBuilder to for a singlesig or multisig transaction.
     *
     * @param {string} amount Amount in mutez to be transferred
     * @returns {TransferBuilder} A transfer builder
     */
    transfer(amount) {
        if (this._type !== sdk_core_1.TransactionType.Send && this._type !== sdk_core_1.TransactionType.SingleSigSend) {
            throw new sdk_core_1.BuildTransactionError('Transfers can only be set for send transactions');
        }
        let transferBuilder = new transferBuilder_1.TransferBuilder();
        // If source was set, use it as default for
        if (this._sourceAddress) {
            transferBuilder = transferBuilder.from(this._sourceAddress);
        }
        if (this._fee) {
            transferBuilder = transferBuilder.fee(this._fee.fee);
            transferBuilder = this._fee.gasLimit ? transferBuilder.gasLimit(this._fee.gasLimit) : transferBuilder;
            transferBuilder = this._fee.storageLimit ? transferBuilder.storageLimit(this._fee.storageLimit) : transferBuilder;
        }
        this._transfers.push(transferBuilder);
        return transferBuilder.amount(amount);
    }
    /**
     * Calculate the signatures for the multisig transaction.
     *
     * @param {string} packedData The string in hexadecimal to sign
     * @returns {Promise<string[]>} List of signatures for packedData
     */
    async getSignatures(packedData) {
        const signatures = [];
        // Generate the multisig contract signatures
        for (let i = 0; i < this._multisigSignerKeyPairs.length; i++) {
            const signature = await utils_1.sign(this._multisigSignerKeyPairs[i].key, packedData, new Uint8Array(0));
            const index = this._multisigSignerKeyPairs[i].index;
            signatures.push(index ? { signature: signature.sig, index } : { signature: signature.sig });
        }
        return signatures;
    }
    /**
     * Override the data to sign for a specific transfer. Used for offline signing to pass the
     * respective dataToSign for transfer at a particular index.
     *
     * @param {DataToSignOverride} data - data to override
     */
    overrideDataToSign(data) {
        if (!data.index) {
            data.index = this._dataToSignOverride.length;
        }
        this._dataToSignOverride.push(data);
    }
    /**
     * Build a transaction operation for a generic multisig contract.
     *
     * @returns {Promise<TransactionOp[]>} A Tezos transaction operation
     */
    async buildSendTransactionContent() {
        const contents = [];
        for (let i = 0; i < this._transfers.length; i++) {
            const transfer = this._transfers[i].build();
            let transactionOp;
            if (utils_1.isValidOriginatedAddress(transfer.from)) {
                // Offline transactions may not have the data to sign
                const signatures = transfer.dataToSign ? await this.getSignatures(transfer.dataToSign) : [];
                transactionOp = multisigUtils_1.multisigTransactionOperation(this._counter.toString(), this._sourceAddress, transfer.amount, transfer.from, transfer.counter || '0', transfer.to, signatures, transfer.fee.fee, transfer.fee.gasLimit, transfer.fee.storageLimit);
            }
            else {
                transactionOp = multisigUtils_1.singlesigTransactionOperation(this._counter.toString(), this._sourceAddress, transfer.amount, transfer.to, transfer.fee.fee, transfer.fee.gasLimit, transfer.fee.storageLimit);
            }
            contents.push(transactionOp);
            this._counter = this._counter.plus(1);
        }
        return contents;
    }
    // endregion
    // region ForwarderAddressDeployment
    /**
     * Build a transaction operation for a forwarder contract
     *
     * @returns {OriginationOp} a Tezos transaction operation
     */
    buildForwarderDeploymentContent() {
        const operation = multisigUtils_1.forwarderOriginationOperation(this._forwarderDestination, this._counter.toString(), this._sourceAddress, this._fee.fee, this._fee.gasLimit || utils_1.DEFAULT_GAS_LIMIT.ORIGINATION.toString(), this._fee.storageLimit || utils_1.DEFAULT_STORAGE_LIMIT.ORIGINATION.toString(), this._initialBalance || '0');
        this._counter = this._counter.plus(1);
        return operation;
    }
    // endregion
    // region Validators
    /** @inheritdoc */
    validateValue(value) {
        if (value.isLessThan(0)) {
            throw new sdk_core_1.BuildTransactionError('Value cannot be below less than zero');
        }
        // TODO: validate the amount is not bigger than the max amount in Tezos
    }
    /** @inheritdoc */
    validateAddress(address) {
        if (!utils_1.isValidAddress(address.address)) {
            throw new sdk_core_1.BuildTransactionError('Invalid address ' + address.address);
        }
    }
    /** @inheritdoc */
    validateKey(key) {
        const keyPair = new keyPair_1.KeyPair({ prv: key.key });
        if (!keyPair.getKeys().prv) {
            throw new sdk_core_1.BuildTransactionError('Invalid key');
        }
    }
    /** @inheritdoc */
    validateRawTransaction(rawTransaction) {
        // TODO: validate the transaction is either a JSON or a hex
    }
    /** @inheritdoc */
    validateTransaction(transaction) {
        // TODO: validate all required fields are present in the builder before buildImplementation
        switch (this._type) {
            case sdk_core_1.TransactionType.AccountUpdate:
                break;
            case sdk_core_1.TransactionType.WalletInitialization:
                break;
            case sdk_core_1.TransactionType.Send:
                break;
            case sdk_core_1.TransactionType.AddressInitialization:
                break;
            case sdk_core_1.TransactionType.SingleSigSend:
                break;
            default:
                throw new sdk_core_1.BuildTransactionError('Transaction type not supported');
        }
    }
    // endregion
    /** @inheritdoc */
    displayName() {
        return this._coinConfig.fullName;
    }
    /** @inheritdoc */
    get transaction() {
        return this._transaction;
    }
    /** @inheritdoc */
    set transaction(transaction) {
        this._transaction = transaction;
    }
}
exports.TransactionBuilder = TransactionBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNhY3Rpb25CdWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi90cmFuc2FjdGlvbkJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsOENBQXdIO0FBRXhILGdFQUFxQztBQUdyQyx1Q0FBb0M7QUFDcEMsbURBTXlCO0FBQ3pCLCtDQUE0QztBQUM1Qyx1REFBb0Q7QUFDcEQsbUNBUWlCO0FBRWpCLE1BQU0sU0FBUyxHQUFHLENBQUMsQ0FBQztBQVVwQjs7R0FFRztBQUNILE1BQWEsa0JBQW1CLFNBQVEsaUNBQXNCO0lBMEI1RDs7OztPQUlHO0lBQ0gsWUFBWSxXQUFpQztRQUMzQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDbkIsSUFBSSxDQUFDLEtBQUssR0FBRywwQkFBZSxDQUFDLElBQUksQ0FBQztRQUNsQyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksc0JBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqQyxJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsc0JBQXNCLEdBQUcsRUFBRSxDQUFDO1FBQ2pDLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxFQUFFLENBQUM7UUFDbEMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLEVBQUUsQ0FBQztRQUM5QixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUkseUJBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRUQsc0JBQXNCO0lBQ3RCLGtCQUFrQjtJQUNSLGtCQUFrQixDQUFDLGNBQXNCO1FBQ2pELDRGQUE0RjtRQUM1RixhQUFhO1FBQ2IsSUFBSSxDQUFDLHNCQUFzQixHQUFHLGNBQWMsQ0FBQztRQUM3QyxPQUFPLElBQUkseUJBQVcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVELGtCQUFrQjtJQUNSLGtCQUFrQixDQUFDLEdBQVE7UUFDbkMs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QyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQzlDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBRyxFQUFFO1lBQzFCLE1BQU0sSUFBSSxnQ0FBcUIsQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUNoRDtJQUNILENBQUM7SUFFRCxrQkFBa0I7SUFDbEIsc0JBQXNCLENBQUMsY0FBbUI7UUFDeEMsMkRBQTJEO0lBQzdELENBQUM7SUFFRCxrQkFBa0I7SUFDbEIsbUJBQW1CLENBQUMsV0FBd0I7UUFDMUMsMkZBQTJGO1FBQzNGLFFBQVEsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNsQixLQUFLLDBCQUFlLENBQUMsYUFBYTtnQkFDaEMsTUFBTTtZQUNSLEtBQUssMEJBQWUsQ0FBQyxvQkFBb0I7Z0JBQ3ZDLE1BQU07WUFDUixLQUFLLDBCQUFlLENBQUMsSUFBSTtnQkFDdkIsTUFBTTtZQUNSLEtBQUssMEJBQWUsQ0FBQyxxQkFBcUI7Z0JBQ3hDLE1BQU07WUFDUixLQUFLLDBCQUFlLENBQUMsYUFBYTtnQkFDaEMsTUFBTTtZQUNSO2dCQUNFLE1BQU0sSUFBSSxnQ0FBcUIsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1NBQ3JFO0lBQ0gsQ0FBQztJQUNELFlBQVk7SUFFWixrQkFBa0I7SUFDbEIsV0FBVztRQUNULE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUM7SUFDbkMsQ0FBQztJQUVELGtCQUFrQjtJQUNsQixJQUFjLFdBQVc7UUFDdkIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDO0lBQzNCLENBQUM7SUFFRCxrQkFBa0I7SUFDbEIsSUFBYyxXQUFXLENBQUMsV0FBd0I7UUFDaEQsSUFBSSxDQUFDLFlBQVksR0FBRyxXQUFXLENBQUM7SUFDbEMsQ0FBQztDQUNGO0FBcGhCRCxnREFvaEJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmFzZUtleSwgQnVpbGRUcmFuc2FjdGlvbkVycm9yLCBTaWduaW5nRXJyb3IsIEJhc2VUcmFuc2FjdGlvbkJ1aWxkZXIsIFRyYW5zYWN0aW9uVHlwZSB9IGZyb20gJ0BiaXRnby9zZGstY29yZSc7XG5pbXBvcnQgeyBCYXNlQ29pbiBhcyBDb2luQ29uZmlnIH0gZnJvbSAnQGJpdGdvL3N0YXRpY3MnO1xuaW1wb3J0IEJpZ051bWJlciBmcm9tICdiaWdudW1iZXIuanMnO1xuaW1wb3J0IHsgQWRkcmVzcyB9IGZyb20gJy4vYWRkcmVzcyc7XG5pbXBvcnQgeyBGZWUsIEluZGV4ZWREYXRhLCBJbmRleGVkU2lnbmF0dXJlLCBLZXksIE9wZXJhdGlvbiwgT3JpZ2luYXRpb25PcCwgUmV2ZWFsT3AsIFRyYW5zYWN0aW9uT3AgfSBmcm9tICcuL2lmYWNlJztcbmltcG9ydCB7IEtleVBhaXIgfSBmcm9tICcuL2tleVBhaXInO1xuaW1wb3J0IHtcbiAgZm9yd2FyZGVyT3JpZ2luYXRpb25PcGVyYXRpb24sXG4gIGdlbmVyaWNNdWx0aXNpZ09yaWdpbmF0aW9uT3BlcmF0aW9uLFxuICBtdWx0aXNpZ1RyYW5zYWN0aW9uT3BlcmF0aW9uLFxuICByZXZlYWxPcGVyYXRpb24sXG4gIHNpbmdsZXNpZ1RyYW5zYWN0aW9uT3BlcmF0aW9uLFxufSBmcm9tICcuL211bHRpc2lnVXRpbHMnO1xuaW1wb3J0IHsgVHJhbnNhY3Rpb24gfSBmcm9tICcuL3RyYW5zYWN0aW9uJztcbmltcG9ydCB7IFRyYW5zZmVyQnVpbGRlciB9IGZyb20gJy4vdHJhbnNmZXJCdWlsZGVyJztcbmltcG9ydCB7XG4gIERFRkFVTFRfR0FTX0xJTUlULFxuICBERUZBVUxUX1NUT1JBR0VfTElNSVQsXG4gIGlzVmFsaWRBZGRyZXNzLFxuICBpc1ZhbGlkQmxvY2tIYXNoLFxuICBpc1ZhbGlkT3JpZ2luYXRlZEFkZHJlc3MsXG4gIGlzVmFsaWRQdWJsaWNLZXksXG4gIHNpZ24sXG59IGZyb20gJy4vdXRpbHMnO1xuXG5jb25zdCBERUZBVUxUX00gPSAzO1xuXG5pbnRlcmZhY2UgRGF0YVRvU2lnbk92ZXJyaWRlIGV4dGVuZHMgSW5kZXhlZERhdGEge1xuICBkYXRhVG9TaWduOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJbmRleGVkS2V5UGFpciBleHRlbmRzIEluZGV4ZWREYXRhIHtcbiAga2V5OiBLZXlQYWlyO1xufVxuXG4vKipcbiAqIFRlem9zIHRyYW5zYWN0aW9uIGJ1aWxkZXIuXG4gKi9cbmV4cG9ydCBjbGFzcyBUcmFuc2FjdGlvbkJ1aWxkZXIgZXh0ZW5kcyBCYXNlVHJhbnNhY3Rpb25CdWlsZGVyIHtcbiAgcHJpdmF0ZSBfc2VyaWFsaXplZFRyYW5zYWN0aW9uOiBzdHJpbmc7XG4gIHByaXZhdGUgX3RyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbjtcbiAgcHJpdmF0ZSBfdHlwZTogVHJhbnNhY3Rpb25UeXBlO1xuICBwcml2YXRlIF9ibG9ja0hlYWRlcjogc3RyaW5nO1xuICBwcml2YXRlIF9jb3VudGVyOiBCaWdOdW1iZXI7XG4gIHByaXZhdGUgX2ZlZTogRmVlO1xuICBwcml2YXRlIF9zb3VyY2VBZGRyZXNzOiBzdHJpbmc7XG4gIHByaXZhdGUgX3NvdXJjZUtleVBhaXI/OiBLZXlQYWlyO1xuXG4gIC8vIFB1YmxpYyBrZXkgcmV2ZWxhdGlvbiB0cmFuc2FjdGlvbiBwYXJhbWV0ZXJzXG4gIHByaXZhdGUgX3B1YmxpY0tleVRvUmV2ZWFsOiBzdHJpbmc7XG5cbiAgLy8gV2FsbGV0IGluaXRpYWxpemF0aW9uIHRyYW5zYWN0aW9uIHBhcmFtZXRlcnNcbiAgcHJpdmF0ZSBfaW5pdGlhbEJhbGFuY2U6IHN0cmluZztcbiAgcHJpdmF0ZSBfaW5pdGlhbERlbGVnYXRlOiBzdHJpbmc7XG4gIHByaXZhdGUgX3dhbGxldE93bmVyUHVibGljS2V5czogc3RyaW5nW107XG5cbiAgLy8gU2VuZCB0cmFuc2FjdGlvbiBwYXJhbWV0ZXJzXG4gIHByaXZhdGUgX211bHRpc2lnU2lnbmVyS2V5UGFpcnM6IEluZGV4ZWRLZXlQYWlyW107XG4gIHByaXZhdGUgX2RhdGFUb1NpZ25PdmVycmlkZTogRGF0YVRvU2lnbk92ZXJyaWRlW107XG4gIHByaXZhdGUgX3RyYW5zZmVyczogVHJhbnNmZXJCdWlsZGVyW107XG5cbiAgLy8gQWRkcmVzcyBpbml0aWFsaXphdGlvbiBwYXJhbWV0ZXJzXG4gIHByaXZhdGUgX2ZvcndhcmRlckRlc3RpbmF0aW9uOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFB1YmxpYyBjb25zdHJ1Y3Rvci5cbiAgICpcbiAgICogQHBhcmFtIHtDb2luQ29uZmlnfSBfY29pbkNvbmZpZyAtIGNvaW4gY29uZmlndXJhdGlvblxuICAgKi9cbiAgY29uc3RydWN0b3IoX2NvaW5Db25maWc6IFJlYWRvbmx5PENvaW5Db25maWc+KSB7XG4gICAgc3VwZXIoX2NvaW5Db25maWcpO1xuICAgIHRoaXMuX3R5cGUgPSBUcmFuc2FjdGlvblR5cGUuU2VuZDtcbiAgICB0aGlzLl9jb3VudGVyID0gbmV3IEJpZ051bWJlcigwKTtcbiAgICB0aGlzLl90cmFuc2ZlcnMgPSBbXTtcbiAgICB0aGlzLl93YWxsZXRPd25lclB1YmxpY0tleXMgPSBbXTtcbiAgICB0aGlzLl9tdWx0aXNpZ1NpZ25lcktleVBhaXJzID0gW107XG4gICAgdGhpcy5fZGF0YVRvU2lnbk92ZXJyaWRlID0gW107XG4gICAgdGhpcy50cmFuc2FjdGlvbiA9IG5ldyBUcmFuc2FjdGlvbihfY29pbkNvbmZpZyk7XG4gIH1cblxuICAvLyByZWdpb24gQmFzZSBCdWlsZGVyXG4gIC8qKiBAaW5oZXJpdGRvYyAqL1xuICBwcm90ZWN0ZWQgZnJvbUltcGxlbWVudGF0aW9uKHJhd1RyYW5zYWN0aW9uOiBzdHJpbmcpOiBUcmFuc2FjdGlvbiB7XG4gICAgLy8gRGVjb2RpbmcgdGhlIHRyYW5zYWN0aW9uIGlzIGFuIGFzeW5jIG9wZXJhdGlvbiwgc28gc2F2ZSBpdCBhbmQgbGVhdmUgdGhlIGRlY29kaW5nIGZvciB0aGVcbiAgICAvLyBidWlsZCBzdGVwXG4gICAgdGhpcy5fc2VyaWFsaXplZFRyYW5zYWN0aW9uID0gcmF3VHJhbnNhY3Rpb247XG4gICAgcmV0dXJuIG5ldyBUcmFuc2FjdGlvbih0aGlzLl9jb2luQ29uZmlnKTtcbiAgfVxuXG4gIC8qKiBAaW5oZXJpdGRvYyAqL1xuICBwcm90ZWN0ZWQgc2lnbkltcGxlbWVudGF0aW9uKGtleTogS2V5KTogVHJhbnNhY3Rpb24ge1xuICAgIGNvbnN0IHNpZ25lciA9IG5ldyBLZXlQYWlyKHsgcHJ2OiBrZXkua2V5IH0pO1xuICAgIC8vIEN1cnJlbnRseSBwdWJsaWMga2V5IHJldmVsYXRpb24gaXMgdGhlIG9ubHkgdHlwZSBvZiBhY2NvdW50IHVwZGF0ZSB0eCBzdXBwb3J0ZWQgaW4gVGV6b3NcbiAgICBpZiAodGhpcy5fdHlwZSA9PT0gVHJhbnNhY3Rpb25UeXBlLkFjY291bnRVcGRhdGUgJiYgIXRoaXMuX3B1YmxpY0tleVRvUmV2ZWFsKSB7XG4gICAgICB0aHJvdyBuZXcgU2lnbmluZ0Vycm9yKCdDYW5ub3Qgc2lnbiBhIHB1YmxpYyBrZXkgcmV2ZWxhdGlvbiB0cmFuc2FjdGlvbiB3aXRob3V0IHB1YmxpYyBrZXknKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5fdHlwZSA9PT0gVHJhbnNhY3Rpb25UeXBlLldhbGxldEluaXRpYWxpemF0aW9uICYmIHRoaXMuX3dhbGxldE93bmVyUHVibGljS2V5cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBTaWduaW5nRXJyb3IoJ0Nhbm5vdCBzaWduIGFuIHdhbGxldCBpbml0aWFsaXphdGlvbiB0cmFuc2FjdGlvbiB3aXRob3V0IG93bmVycycpO1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgIHRoaXMuX3R5cGUgPT09IFRyYW5zYWN0aW9uVHlwZS5TZW5kICYmXG4gICAgICB0aGlzLl90cmFuc2ZlcnMubGVuZ3RoID09PSAwICYmXG4gICAgICB0aGlzLl9zZXJpYWxpemVkVHJhbnNhY3Rpb24gPT09IHVuZGVmaW5lZFxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IFNpZ25pbmdFcnJvcignQ2Fubm90IHNpZ24gYW4gZW1wdHkgc2VuZCB0cmFuc2FjdGlvbicpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLl90eXBlID09PSBUcmFuc2FjdGlvblR5cGUuU2VuZCAmJiAoIXRoaXMuX3NvdXJjZUFkZHJlc3MgfHwgdGhpcy5fc291cmNlQWRkcmVzcyAhPT0gc2lnbmVyLmdldEFkZHJlc3MoKSkpIHtcbiAgICAgIC8vIElmIHRoZSBzaWduZXIgaXMgbm90IHRoZSBzb3VyY2UgYW5kIGl0IGlzIGEgc2VuZCB0cmFuc2FjdGlvbiwgYWRkIGl0IHRvIHRoZSBsaXN0IG9mXG4gICAgICAvLyBtdWx0aXNpZyB3YWxsZXQgc2lnbmVyc1xuXG4gICAgICAvLyBUT0RPOiBzdXBwb3J0IGEgY29tYmluYXRpb24gb2Yga2V5cyB3aXRoIGFuZCB3aXRob3V0IGN1c3RvbSBpbmRleFxuICAgICAgaWYgKGtleS5pbmRleCAmJiBrZXkuaW5kZXggPj0gREVGQVVMVF9NKSB7XG4gICAgICAgIHRocm93IG5ldyBCdWlsZFRyYW5zYWN0aW9uRXJyb3IoXG4gICAgICAgICAgJ0N1c3RvbSBpbmRleCBjYW5ub3QgYmUgZ3JlYXRlciB0aGFuIHRoZSB3YWxsZXQgdG90YWwgbnVtYmVyIG9mIHNpZ25lcnMgKG93bmVycyknXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICAvLyBNYWtlIHN1cmUgZWl0aGVyIGFsbCBrZXlzIHBhc3NlZCBoYXZlIGEgY3VzdG9tIGluZGV4IG9yIG5vbmUgb2YgdGhlbSBoYXZlXG4gICAgICBjb25zdCBzaG91bGRIYXZlQ3VzdG9tSW5kZXggPSBrZXkuaGFzT3duUHJvcGVydHkoJ2luZGV4Jyk7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX211bHRpc2lnU2lnbmVyS2V5UGFpcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaWYgKHNob3VsZEhhdmVDdXN0b21JbmRleCAhPT0gKHRoaXMuX211bHRpc2lnU2lnbmVyS2V5UGFpcnNbaV0uaW5kZXggIT09IHVuZGVmaW5lZCkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQnVpbGRUcmFuc2FjdGlvbkVycm9yKCdDdXN0b20gaW5kZXggaGFzIHRvIGJlIHNldCBmb3IgYWxsIG11bHRpc2lnIGNvbnRyYWN0IHNpZ25pbmcga2V5cyBvciBub25lJyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNvbnN0IG11bHRpc2lnU2lnbmVyS2V5ID0gc2hvdWxkSGF2ZUN1c3RvbUluZGV4ID8geyBrZXk6IHNpZ25lciwgaW5kZXg6IGtleS5pbmRleCB9IDogeyBrZXk6IHNpZ25lciB9O1xuICAgICAgdGhpcy5fbXVsdGlzaWdTaWduZXJLZXlQYWlycy5wdXNoKG11bHRpc2lnU2lnbmVyS2V5KTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMuX3NvdXJjZUtleVBhaXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IFNpZ25pbmdFcnJvcignQ2Fubm90IHNpZ24gbXVsdGlwbGUgdGltZXMgYSBub24gc2VuZC10eXBlIHRyYW5zYWN0aW9uJyk7XG4gICAgICB9XG4gICAgICB0aGlzLl9zb3VyY2VLZXlQYWlyID0gc2lnbmVyO1xuICAgIH1cblxuICAgIC8vIFNpZ25pbmcgdGhlIHRyYW5zYWN0aW9uIGlzIGFuIGFzeW5jIG9wZXJhdGlvbiwgc28gc2F2ZSB0aGUgc291cmNlIGFuZCBsZWF2ZSB0aGUgYWN0dWFsXG4gICAgLy8gc2lnbmluZyBmb3IgdGhlIGJ1aWxkIHN0ZXBcbiAgICByZXR1cm4gdGhpcy50cmFuc2FjdGlvbjtcbiAgfVxuXG4gIC8qKiBAaW5oZXJpdGRvYyAqL1xuICBwcm90ZWN0ZWQgYXN5bmMgYnVpbGRJbXBsZW1lbnRhdGlvbigpOiBQcm9taXNlPFRyYW5zYWN0aW9uPiB7XG4gICAgLy8gSWYgdGhlIGZyb20oKSBtZXRob2Qgd2FzIGNhbGxlZCwgdXNlIHRoZSBzZXJpYWxpemVkIHRyYW5zYWN0aW9uIGFzIGEgYmFzZVxuICAgIGlmICh0aGlzLl9zZXJpYWxpemVkVHJhbnNhY3Rpb24pIHtcbiAgICAgIGF3YWl0IHRoaXMudHJhbnNhY3Rpb24uaW5pdEZyb21TZXJpYWxpemVkVHJhbnNhY3Rpb24odGhpcy5fc2VyaWFsaXplZFRyYW5zYWN0aW9uKTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fZGF0YVRvU2lnbk92ZXJyaWRlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHNpZ25hdHVyZXMgPSBhd2FpdCB0aGlzLmdldFNpZ25hdHVyZXModGhpcy5fZGF0YVRvU2lnbk92ZXJyaWRlW2ldLmRhdGFUb1NpZ24pO1xuICAgICAgICBhd2FpdCB0aGlzLnRyYW5zYWN0aW9uLmFkZFRyYW5zZmVyU2lnbmF0dXJlKHNpZ25hdHVyZXMsIHRoaXMuX2RhdGFUb1NpZ25PdmVycmlkZVtpXS5pbmRleCB8fCBpKTtcbiAgICAgIH1cbiAgICAgIC8vIFRPRE86IG1ha2UgY2hhbmdlcyB0byB0aGUgdHJhbnNhY3Rpb24gaWYgYW55IGV4dHJhIHBhcmFtZXRlciBoYXMgYmVlbiBzZXQgdGhlbiBzaWduIGl0XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBjb250ZW50czogT3BlcmF0aW9uW10gPSBbXTtcbiAgICAgIHN3aXRjaCAodGhpcy5fdHlwZSkge1xuICAgICAgICBjYXNlIFRyYW5zYWN0aW9uVHlwZS5BY2NvdW50VXBkYXRlOlxuICAgICAgICAgIGlmICh0aGlzLl9wdWJsaWNLZXlUb1JldmVhbCkge1xuICAgICAgICAgICAgY29udGVudHMucHVzaCh0aGlzLmJ1aWxkUHVibGljS2V5UmV2ZWxhdGlvbk9wZXJhdGlvbigpKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgVHJhbnNhY3Rpb25UeXBlLldhbGxldEluaXRpYWxpemF0aW9uOlxuICAgICAgICAgIGlmICh0aGlzLl9wdWJsaWNLZXlUb1JldmVhbCkge1xuICAgICAgICAgICAgY29udGVudHMucHVzaCh0aGlzLmJ1aWxkUHVibGljS2V5UmV2ZWxhdGlvbk9wZXJhdGlvbigpKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29udGVudHMucHVzaCh0aGlzLmJ1aWxkV2FsbGV0SW5pdGlhbGl6YXRpb25PcGVyYXRpb25zKCkpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFRyYW5zYWN0aW9uVHlwZS5TZW5kOlxuICAgICAgICAgIGlmICh0aGlzLl9wdWJsaWNLZXlUb1JldmVhbCkge1xuICAgICAgICAgICAgY29udGVudHMucHVzaCh0aGlzLmJ1aWxkUHVibGljS2V5UmV2ZWxhdGlvbk9wZXJhdGlvbigpKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29udGVudHMgPSBjb250ZW50cy5jb25jYXQoYXdhaXQgdGhpcy5idWlsZFNlbmRUcmFuc2FjdGlvbkNvbnRlbnQoKSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgVHJhbnNhY3Rpb25UeXBlLkFkZHJlc3NJbml0aWFsaXphdGlvbjpcbiAgICAgICAgICBpZiAodGhpcy5fcHVibGljS2V5VG9SZXZlYWwpIHtcbiAgICAgICAgICAgIGNvbnRlbnRzLnB1c2godGhpcy5idWlsZFB1YmxpY0tleVJldmVsYXRpb25PcGVyYXRpb24oKSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnRlbnRzID0gY29udGVudHMuY29uY2F0KHRoaXMuYnVpbGRGb3J3YXJkZXJEZXBsb3ltZW50Q29udGVudCgpKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUcmFuc2FjdGlvblR5cGUuU2luZ2xlU2lnU2VuZDpcbiAgICAgICAgICAvLyBObyBzdXBwb3J0IGZvciByZXZlbGF0aW9uIHR4bnMgYXMgcHJpbWFyeSB1c2UgY2FzZSBpcyB0byBzZW5kIGZyb20gZmVlIGFkZHJlc3NcbiAgICAgICAgICBjb250ZW50cyA9IGNvbnRlbnRzLmNvbmNhdChhd2FpdCB0aGlzLmJ1aWxkU2VuZFRyYW5zYWN0aW9uQ29udGVudCgpKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICB0aHJvdyBuZXcgQnVpbGRUcmFuc2FjdGlvbkVycm9yKCdVbnN1cHBvcnRlZCB0cmFuc2FjdGlvbiB0eXBlJyk7XG4gICAgICB9XG4gICAgICBpZiAoY29udGVudHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRocm93IG5ldyBCdWlsZFRyYW5zYWN0aW9uRXJyb3IoJ0VtcHR5IHRyYW5zYWN0aW9uJyk7XG4gICAgICB9XG4gICAgICBjb25zdCBwYXJzZWRUcmFuc2FjdGlvbiA9IHtcbiAgICAgICAgYnJhbmNoOiB0aGlzLl9ibG9ja0hlYWRlcixcbiAgICAgICAgY29udGVudHMsXG4gICAgICB9O1xuXG4gICAgICB0aGlzLnRyYW5zYWN0aW9uID0gbmV3IFRyYW5zYWN0aW9uKHRoaXMuX2NvaW5Db25maWcpO1xuICAgICAgLy8gQnVpbGQgYW5kIHNpZ24gYSBuZXcgdHJhbnNhY3Rpb24gYmFzZWQgb24gdGhlIGxhdGVzdCBjaGFuZ2VzXG4gICAgICBhd2FpdCB0aGlzLnRyYW5zYWN0aW9uLmluaXRGcm9tUGFyc2VkVHJhbnNhY3Rpb24ocGFyc2VkVHJhbnNhY3Rpb24pO1xuICAgIH1cblxuICAgIGlmICh0aGlzLl9zb3VyY2VLZXlQYWlyICYmIHRoaXMuX3NvdXJjZUtleVBhaXIuZ2V0S2V5cygpLnBydikge1xuICAgICAgLy8gVE9ETzogY2hlY2sgaWYgdGhlcmUgYXJlIG1vcmUgc2lnbmVycyB0aGFuIG5lZWRlZCBmb3IgYSBzaW5nbGVzaWcgb3IgbXVsdGlzaWcgdHJhbnNhY3Rpb25cbiAgICAgIGF3YWl0IHRoaXMudHJhbnNhY3Rpb24uc2lnbih0aGlzLl9zb3VyY2VLZXlQYWlyKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudHJhbnNhY3Rpb247XG4gIH1cbiAgLy8gZW5kcmVnaW9uXG5cbiAgLy8gcmVnaW9uIENvbW1vbiBidWlsZGVyIG1ldGhvZHNcbiAgLyoqXG4gICAqIFNldCB0aGUgdHJhbnNhY3Rpb24gYnJhbmNoIGlkLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gYmxvY2tJZCBBIGJsb2NrIGhhc2ggdG8gdXNlIGFzIGJyYW5jaCByZWZlcmVuY2VcbiAgICovXG4gIGJyYW5jaChibG9ja0lkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoIWlzVmFsaWRCbG9ja0hhc2goYmxvY2tJZCkpIHtcbiAgICAgIHRocm93IG5ldyBCdWlsZFRyYW5zYWN0aW9uRXJyb3IoJ0ludmFsaWQgYmxvY2sgaGFzaCAnICsgYmxvY2tJZCk7XG4gICAgfVxuICAgIHRoaXMuX2Jsb2NrSGVhZGVyID0gYmxvY2tJZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgdHlwZSBvZiB0cmFuc2FjdGlvbiBiZWluZyBidWlsdC5cbiAgICpcbiAgICogQHBhcmFtIHtUcmFuc2FjdGlvblR5cGV9IHR5cGUgLSB0eXBlIG9mIHRoZSB0cmFuc2FjdGlvblxuICAgKi9cbiAgdHlwZSh0eXBlOiBUcmFuc2FjdGlvblR5cGUpOiB2b2lkIHtcbiAgICBpZiAodHlwZSA9PT0gVHJhbnNhY3Rpb25UeXBlLlNlbmQgJiYgdGhpcy5fd2FsbGV0T3duZXJQdWJsaWNLZXlzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBCdWlsZFRyYW5zYWN0aW9uRXJyb3IoJ1RyYW5zYWN0aW9uIGNhbm5vdCBiZSBsYWJlbGVkIGFzIFNlbmQgd2hlbiBvd25lcnMgaGF2ZSBhbHJlYWR5IGJlZW4gc2V0Jyk7XG4gICAgfVxuICAgIGlmICh0eXBlICE9PSBUcmFuc2FjdGlvblR5cGUuU2VuZCAmJiB0aGlzLl90cmFuc2ZlcnMubGVuZ3RoID4gMCkge1xuICAgICAgdGhyb3cgbmV3IEJ1aWxkVHJhbnNhY3Rpb25FcnJvcignVHJhbnNhY3Rpb24gY29udGFpbnMgdHJhbnNmZXJzIGFuZCBjYW4gb25seSBiZSBsYWJlbGVkIGFzIFNlbmQnKTtcbiAgICB9XG4gICAgdGhpcy5fdHlwZSA9IHR5cGU7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSB0cmFuc2FjdGlvbiBmZWVzLiBMb3cgZmVlcyBtYXkgZ2V0IGEgdHJhbnNhY3Rpb24gcmVqZWN0ZWQgb3IgbmV2ZXIgcGlja2VkIHVwIGJ5IGJha2Vycy5cbiAgICpcbiAgICogQHBhcmFtIHtGZWV9IGZlZSBCYWtlciBmZWVzLiBNYXkgYWxzbyBpbmNsdWRlIHRoZSBtYXhpbXVtIGdhcyBhbmQgc3RvcmFnZSBmZWVzIHRvIHBheVxuICAgKi9cbiAgZmVlKGZlZTogRmVlKTogdm9pZCB7XG4gICAgdGhpcy52YWxpZGF0ZVZhbHVlKG5ldyBCaWdOdW1iZXIoZmVlLmZlZSkpO1xuICAgIGlmIChmZWUuZ2FzTGltaXQpIHtcbiAgICAgIHRoaXMudmFsaWRhdGVWYWx1ZShuZXcgQmlnTnVtYmVyKGZlZS5nYXNMaW1pdCkpO1xuICAgIH1cbiAgICBpZiAoZmVlLnN0b3JhZ2VMaW1pdCkge1xuICAgICAgdGhpcy52YWxpZGF0ZVZhbHVlKG5ldyBCaWdOdW1iZXIoZmVlLnN0b3JhZ2VMaW1pdCkpO1xuICAgIH1cbiAgICB0aGlzLl9mZWUgPSBmZWU7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSB0cmFuc2FjdGlvbiBpbml0aWF0b3IuIFRoaXMgYWNjb3VudCB3aWxsIHBheSBmb3IgdGhlIHRyYW5zYWN0aW9uIGZlZXMsIGJ1dCBpdCB3aWxsIG5vdFxuICAgKiBiZSBhZGRlZCBhcyBhbiBvd25lciBvZiBhIHdhbGxldCBpbiBhIGluaXQgdHJhbnNhY3Rpb24sIHVubGVzcyBtYW51YWxseSBzZXQgYXMgb25lIG9mIHRoZVxuICAgKiBvd25lcnMuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzb3VyY2UgQSBUZXpvcyBhZGRyZXNzXG4gICAqL1xuICBzb3VyY2Uoc291cmNlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLnZhbGlkYXRlQWRkcmVzcyh7IGFkZHJlc3M6IHNvdXJjZSB9KTtcbiAgICB0aGlzLl9zb3VyY2VBZGRyZXNzID0gc291cmNlO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBhbiBhbW91bnQgb2YgbXV0ZXogdG8gdHJhbnNmZXIgaW4gdGhpcyB0cmFuc2FjdGlvbiB0aGlzIHRyYW5zYWN0aW9uLiBUaGlzIGlzIGRpZmZlcmVudCB0aGFuXG4gICAqIHRoZSBhbW91bnQgdG8gdHJhbnNmZXIgZnJvbSBhIG11bHRpc2lnIHdhbGxldC5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGFtb3VudCBBbW91bnQgaW4gbXV0ZXogKDEvMTAwMDAwMCBUZXppZXMpXG4gICAqL1xuICBpbml0aWFsQmFsYW5jZShhbW91bnQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0aGlzLl90eXBlICE9PSBUcmFuc2FjdGlvblR5cGUuV2FsbGV0SW5pdGlhbGl6YXRpb24pIHtcbiAgICAgIHRocm93IG5ldyBCdWlsZFRyYW5zYWN0aW9uRXJyb3IoJ0luaXRpYWwgYmFsYW5jZSBjYW4gb25seSBiZSBzZXQgZm9yIHdhbGxldCBpbml0aWFsaXphdGlvbiB0cmFuc2FjdGlvbnMnKTtcbiAgICB9XG4gICAgdGhpcy52YWxpZGF0ZVZhbHVlKG5ldyBCaWdOdW1iZXIoYW1vdW50KSk7XG4gICAgdGhpcy5faW5pdGlhbEJhbGFuY2UgPSBhbW91bnQ7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSB0cmFuc2FjdGlvbiBjb3VudGVyIHRvIHByZXZlbnQgc3VibWl0dGluZyByZXBlYXRlZCB0cmFuc2FjdGlvbnMuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjb3VudGVyIFRoZSBjb3VudGVyIHRvIHVzZVxuICAgKi9cbiAgY291bnRlcihjb3VudGVyOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLl9jb3VudGVyID0gbmV3IEJpZ051bWJlcihjb3VudGVyKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdGhlIGRlc3RpbmF0aW9uIGFkZHJlc3Mgb2YgYSBmb3J3YXJkZXIgY29udHJhY3RcbiAgICogVXNlZCBpbiBmb3J3YXJkZXIgY29udHJhY3QgZGVwbG95bWVudCBhcyBkZXN0aW5hdGlvbiBhZGRyZXNzXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjb250cmFjdEFkZHJlc3MgLSBjb250cmFjdCBhZGRyZXNzIHRvIHVzZVxuICAgKi9cbiAgZm9yd2FyZGVyRGVzdGluYXRpb24oY29udHJhY3RBZGRyZXNzOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fdHlwZSAhPT0gVHJhbnNhY3Rpb25UeXBlLkFkZHJlc3NJbml0aWFsaXphdGlvbikge1xuICAgICAgdGhyb3cgbmV3IEJ1aWxkVHJhbnNhY3Rpb25FcnJvcignRm9yd2FyZGVyIGRlc3RpbmF0aW9uIGNhbiBvbmx5IGJlIHNldCBmb3IgYWRkcmVzcyBpbml0aWFsaXphdGlvbiB0cmFuc2FjdGlvbnMnKTtcbiAgICB9XG4gICAgaWYgKCFpc1ZhbGlkT3JpZ2luYXRlZEFkZHJlc3MoY29udHJhY3RBZGRyZXNzKSkge1xuICAgICAgdGhyb3cgbmV3IEJ1aWxkVHJhbnNhY3Rpb25FcnJvcignRm9yd2FyZGVyIGRlc3RpbmF0aW9uIGNhbiBvbmx5IGJlIGFuIG9yaWdpbmF0ZWQgYWRkcmVzcycpO1xuICAgIH1cbiAgICB0aGlzLl9mb3J3YXJkZXJEZXN0aW5hdGlvbiA9IGNvbnRyYWN0QWRkcmVzcztcbiAgfVxuXG4gIC8vIGVuZHJlZ2lvblxuXG4gIC8vIHJlZ2lvbiBQdWJsaWNLZXlSZXZlbGF0aW9uIGJ1aWxkZXIgbWV0aG9kc1xuICAvKipcbiAgICogVGhlIHB1YmxpYyBrZXkgdG8gcmV2ZWFsLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gcHVibGljS2V5IEEgVGV6b3MgcHVibGljIGtleVxuICAgKi9cbiAgcHVibGljS2V5VG9SZXZlYWwocHVibGljS2V5OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fcHVibGljS2V5VG9SZXZlYWwpIHtcbiAgICAgIHRocm93IG5ldyBCdWlsZFRyYW5zYWN0aW9uRXJyb3IoJ1B1YmxpYyBrZXkgdG8gcmV2ZWFsIGFscmVhZHkgc2V0OiAnICsgdGhpcy5fcHVibGljS2V5VG9SZXZlYWwpO1xuICAgIH1cblxuICAgIGNvbnN0IGtleVBhaXIgPSBuZXcgS2V5UGFpcih7IHB1YjogcHVibGljS2V5IH0pO1xuICAgIGlmIChrZXlQYWlyLmdldEFkZHJlc3MoKSAhPT0gdGhpcy5fc291cmNlQWRkcmVzcykge1xuICAgICAgdGhyb3cgbmV3IEJ1aWxkVHJhbnNhY3Rpb25FcnJvcignUHVibGljIGtleSBkb2VzIG5vdCBtYXRjaCB0aGUgc291cmNlIGFkZHJlc3M6ICcgKyB0aGlzLl9zb3VyY2VBZGRyZXNzKTtcbiAgICB9XG4gICAgdGhpcy5fcHVibGljS2V5VG9SZXZlYWwgPSBrZXlQYWlyLmdldEtleXMoKS5wdWI7XG4gIH1cblxuICAvKipcbiAgICogQnVpbGQgYSByZXZlYWwgb3BlcmF0aW9uIGZvciB0aGUgc291cmNlIGFjY291bnQgd2l0aCBkZWZhdWx0IGZlZXMuXG4gICAqXG4gICAqIEByZXR1cm5zIHtSZXZlYWxPcH0gQSBUZXpvcyByZXZlYWwgb3BlcmF0aW9uXG4gICAqL1xuICBwcml2YXRlIGJ1aWxkUHVibGljS2V5UmV2ZWxhdGlvbk9wZXJhdGlvbigpOiBSZXZlYWxPcCB7XG4gICAgY29uc3Qgb3BlcmF0aW9uID0gcmV2ZWFsT3BlcmF0aW9uKHRoaXMuX2NvdW50ZXIudG9TdHJpbmcoKSwgdGhpcy5fc291cmNlQWRkcmVzcywgdGhpcy5fcHVibGljS2V5VG9SZXZlYWwpO1xuICAgIHRoaXMuX2NvdW50ZXIgPSB0aGlzLl9jb3VudGVyLnBsdXMoMSk7XG4gICAgcmV0dXJuIG9wZXJhdGlvbjtcbiAgfVxuICAvLyBlbmRyZWdpb25cblxuICAvLyByZWdpb24gV2FsbGV0SW5pdGlhbGl6YXRpb24gYnVpbGRlciBtZXRob2RzXG4gIC8qKlxuICAgKiBTZXQgb25lIG9mIHRoZSBvd25lcnMgb2YgdGhlIG11bHRpc2lnIHdhbGxldC5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHB1YmxpY0tleSBBIFRlem9zIHB1YmxpYyBrZXlcbiAgICovXG4gIG93bmVyKHB1YmxpY0tleTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX3R5cGUgIT09IFRyYW5zYWN0aW9uVHlwZS5XYWxsZXRJbml0aWFsaXphdGlvbikge1xuICAgICAgdGhyb3cgbmV3IEJ1aWxkVHJhbnNhY3Rpb25FcnJvcignTXVsdGlzaWcgd2FsbGV0IG93bmVyIGNhbiBvbmx5IGJlIHNldCBmb3IgaW5pdGlhbGl6YXRpb24gdHJhbnNhY3Rpb25zJyk7XG4gICAgfVxuICAgIGlmICh0aGlzLl93YWxsZXRPd25lclB1YmxpY0tleXMubGVuZ3RoID49IERFRkFVTFRfTSkge1xuICAgICAgdGhyb3cgbmV3IEJ1aWxkVHJhbnNhY3Rpb25FcnJvcignQSBtYXhpbXVtIG9mICcgKyBERUZBVUxUX00gKyAnIG93bmVycyBjYW4gYmUgc2V0IGZvciBhIG11bHRpc2lnIHdhbGxldCcpO1xuICAgIH1cbiAgICBpZiAoIWlzVmFsaWRQdWJsaWNLZXkocHVibGljS2V5KSkge1xuICAgICAgdGhyb3cgbmV3IEJ1aWxkVHJhbnNhY3Rpb25FcnJvcignSW52YWxpZCBwdWJsaWMga2V5OiAnICsgcHVibGljS2V5KTtcbiAgICB9XG4gICAgaWYgKHRoaXMuX3dhbGxldE93bmVyUHVibGljS2V5cy5pbmNsdWRlcyhwdWJsaWNLZXkpKSB7XG4gICAgICB0aHJvdyBuZXcgQnVpbGRUcmFuc2FjdGlvbkVycm9yKCdSZXBlYXRlZCBvd25lciBwdWJsaWMga2V5OiAnICsgcHVibGljS2V5KTtcbiAgICB9XG4gICAgdGhpcy5fd2FsbGV0T3duZXJQdWJsaWNLZXlzLnB1c2gocHVibGljS2V5KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgYW4gaW5pdGlhbCBkZWxlZ2F0ZSB0byBpbml0aWFsaXplIHRoaXMgd2FsbGV0IHRvLiBUaGlzIGlzIGRpZmZlcmVudCB0aGFuIHRoZSBkZWxlZ2F0aW9uIHRvXG4gICAqIHNldCB3aGlsZSBkb2luZyBhIHNlcGFyYXRlIGRlbGVnYXRpb24gdHJhbnNhY3Rpb24uXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBkZWxlZ2F0ZSBUaGUgYWRkcmVzcyB0byBkZWxlZ2F0ZSB0aGUgZnVuZHMgdG9cbiAgICovXG4gIGluaXRpYWxEZWxlZ2F0ZShkZWxlZ2F0ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX3R5cGUgIT09IFRyYW5zYWN0aW9uVHlwZS5XYWxsZXRJbml0aWFsaXphdGlvbikge1xuICAgICAgdGhyb3cgbmV3IEJ1aWxkVHJhbnNhY3Rpb25FcnJvcignSW5pdGlhbCBkZWxlZ2F0aW9uIGNhbiBvbmx5IGJlIHNldCBmb3Igd2FsbGV0IGluaXRpYWxpemF0aW9uIHRyYW5zYWN0aW9ucycpO1xuICAgIH1cbiAgICB0aGlzLnZhbGlkYXRlQWRkcmVzcyh7IGFkZHJlc3M6IGRlbGVnYXRlIH0pO1xuICAgIHRoaXMuX2luaXRpYWxEZWxlZ2F0ZSA9IGRlbGVnYXRlO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1aWxkIGFuIG9yaWdpbmF0aW9uIG9wZXJhdGlvbiBmb3IgYSBnZW5lcmljIG11bHRpc2lnIGNvbnRyYWN0LlxuICAgKlxuICAgKiBAcmV0dXJucyB7T3BlcmF0aW9ufSBBIFRlem9zIG9yaWdpbmF0aW9uIG9wZXJhdGlvblxuICAgKi9cbiAgcHJpdmF0ZSBidWlsZFdhbGxldEluaXRpYWxpemF0aW9uT3BlcmF0aW9ucygpOiBPcmlnaW5hdGlvbk9wIHtcbiAgICBjb25zdCBvcmlnaW5hdGlvbk9wID0gZ2VuZXJpY011bHRpc2lnT3JpZ2luYXRpb25PcGVyYXRpb24oXG4gICAgICB0aGlzLl9jb3VudGVyLnRvU3RyaW5nKCksXG4gICAgICB0aGlzLl9zb3VyY2VBZGRyZXNzLFxuICAgICAgdGhpcy5fZmVlLmZlZSxcbiAgICAgIHRoaXMuX2ZlZS5nYXNMaW1pdCB8fCBERUZBVUxUX0dBU19MSU1JVC5PUklHSU5BVElPTi50b1N0cmluZygpLFxuICAgICAgdGhpcy5fZmVlLnN0b3JhZ2VMaW1pdCB8fCBERUZBVUxUX1NUT1JBR0VfTElNSVQuT1JJR0lOQVRJT04udG9TdHJpbmcoKSxcbiAgICAgIHRoaXMuX2luaXRpYWxCYWxhbmNlIHx8ICcwJyxcbiAgICAgIHRoaXMuX3dhbGxldE93bmVyUHVibGljS2V5cyxcbiAgICAgIHRoaXMuX2luaXRpYWxEZWxlZ2F0ZVxuICAgICk7XG4gICAgdGhpcy5fY291bnRlciA9IHRoaXMuX2NvdW50ZXIucGx1cygxKTtcbiAgICByZXR1cm4gb3JpZ2luYXRpb25PcDtcbiAgfVxuICAvLyBlbmRyZWdpb25cblxuICAvLyByZWdpb24gU2VuZCBidWlsZGVyIG1ldGhvZHNcbiAgLyoqXG4gICAqIEluaXRpYWxpemUgYSBuZXcgVHJhbnNmZXJCdWlsZGVyIHRvIGZvciBhIHNpbmdsZXNpZyBvciBtdWx0aXNpZyB0cmFuc2FjdGlvbi5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGFtb3VudCBBbW91bnQgaW4gbXV0ZXogdG8gYmUgdHJhbnNmZXJyZWRcbiAgICogQHJldHVybnMge1RyYW5zZmVyQnVpbGRlcn0gQSB0cmFuc2ZlciBidWlsZGVyXG4gICAqL1xuICB0cmFuc2ZlcihhbW91bnQ6IHN0cmluZyk6IFRyYW5zZmVyQnVpbGRlciB7XG4gICAgaWYgKHRoaXMuX3R5cGUgIT09IFRyYW5zYWN0aW9uVHlwZS5TZW5kICYmIHRoaXMuX3R5cGUgIT09IFRyYW5zYWN0aW9uVHlwZS5TaW5nbGVTaWdTZW5kKSB7XG4gICAgICB0aHJvdyBuZXcgQnVpbGRUcmFuc2FjdGlvbkVycm9yKCdUcmFuc2ZlcnMgY2FuIG9ubHkgYmUgc2V0IGZvciBzZW5kIHRyYW5zYWN0aW9ucycpO1xuICAgIH1cbiAgICBsZXQgdHJhbnNmZXJCdWlsZGVyID0gbmV3IFRyYW5zZmVyQnVpbGRlcigpO1xuICAgIC8vIElmIHNvdXJjZSB3YXMgc2V0LCB1c2UgaXQgYXMgZGVmYXVsdCBmb3JcbiAgICBpZiAodGhpcy5fc291cmNlQWRkcmVzcykge1xuICAgICAgdHJhbnNmZXJCdWlsZGVyID0gdHJhbnNmZXJCdWlsZGVyLmZyb20odGhpcy5fc291cmNlQWRkcmVzcyk7XG4gICAgfVxuICAgIGlmICh0aGlzLl9mZWUpIHtcbiAgICAgIHRyYW5zZmVyQnVpbGRlciA9IHRyYW5zZmVyQnVpbGRlci5mZWUodGhpcy5fZmVlLmZlZSk7XG4gICAgICB0cmFuc2ZlckJ1aWxkZXIgPSB0aGlzLl9mZWUuZ2FzTGltaXQgPyB0cmFuc2ZlckJ1aWxkZXIuZ2FzTGltaXQodGhpcy5fZmVlLmdhc0xpbWl0KSA6IHRyYW5zZmVyQnVpbGRlcjtcbiAgICAgIHRyYW5zZmVyQnVpbGRlciA9IHRoaXMuX2ZlZS5zdG9yYWdlTGltaXQgPyB0cmFuc2ZlckJ1aWxkZXIuc3RvcmFnZUxpbWl0KHRoaXMuX2ZlZS5zdG9yYWdlTGltaXQpIDogdHJhbnNmZXJCdWlsZGVyO1xuICAgIH1cbiAgICB0aGlzLl90cmFuc2ZlcnMucHVzaCh0cmFuc2ZlckJ1aWxkZXIpO1xuICAgIHJldHVybiB0cmFuc2ZlckJ1aWxkZXIuYW1vdW50KGFtb3VudCk7XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYXRlIHRoZSBzaWduYXR1cmVzIGZvciB0aGUgbXVsdGlzaWcgdHJhbnNhY3Rpb24uXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwYWNrZWREYXRhIFRoZSBzdHJpbmcgaW4gaGV4YWRlY2ltYWwgdG8gc2lnblxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxzdHJpbmdbXT59IExpc3Qgb2Ygc2lnbmF0dXJlcyBmb3IgcGFja2VkRGF0YVxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBnZXRTaWduYXR1cmVzKHBhY2tlZERhdGE6IHN0cmluZyk6IFByb21pc2U8SW5kZXhlZFNpZ25hdHVyZVtdPiB7XG4gICAgY29uc3Qgc2lnbmF0dXJlczogSW5kZXhlZFNpZ25hdHVyZVtdID0gW107XG4gICAgLy8gR2VuZXJhdGUgdGhlIG11bHRpc2lnIGNvbnRyYWN0IHNpZ25hdHVyZXNcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX211bHRpc2lnU2lnbmVyS2V5UGFpcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHNpZ25hdHVyZSA9IGF3YWl0IHNpZ24odGhpcy5fbXVsdGlzaWdTaWduZXJLZXlQYWlyc1tpXS5rZXksIHBhY2tlZERhdGEsIG5ldyBVaW50OEFycmF5KDApKTtcbiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5fbXVsdGlzaWdTaWduZXJLZXlQYWlyc1tpXS5pbmRleDtcbiAgICAgIHNpZ25hdHVyZXMucHVzaChpbmRleCA/IHsgc2lnbmF0dXJlOiBzaWduYXR1cmUuc2lnLCBpbmRleCB9IDogeyBzaWduYXR1cmU6IHNpZ25hdHVyZS5zaWcgfSk7XG4gICAgfVxuICAgIHJldHVybiBzaWduYXR1cmVzO1xuICB9XG5cbiAgLyoqXG4gICAqIE92ZXJyaWRlIHRoZSBkYXRhIHRvIHNpZ24gZm9yIGEgc3BlY2lmaWMgdHJhbnNmZXIuIFVzZWQgZm9yIG9mZmxpbmUgc2lnbmluZyB0byBwYXNzIHRoZVxuICAgKiByZXNwZWN0aXZlIGRhdGFUb1NpZ24gZm9yIHRyYW5zZmVyIGF0IGEgcGFydGljdWxhciBpbmRleC5cbiAgICpcbiAgICogQHBhcmFtIHtEYXRhVG9TaWduT3ZlcnJpZGV9IGRhdGEgLSBkYXRhIHRvIG92ZXJyaWRlXG4gICAqL1xuICBvdmVycmlkZURhdGFUb1NpZ24oZGF0YTogRGF0YVRvU2lnbk92ZXJyaWRlKTogdm9pZCB7XG4gICAgaWYgKCFkYXRhLmluZGV4KSB7XG4gICAgICBkYXRhLmluZGV4ID0gdGhpcy5fZGF0YVRvU2lnbk92ZXJyaWRlLmxlbmd0aDtcbiAgICB9XG4gICAgdGhpcy5fZGF0YVRvU2lnbk92ZXJyaWRlLnB1c2goZGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogQnVpbGQgYSB0cmFuc2FjdGlvbiBvcGVyYXRpb24gZm9yIGEgZ2VuZXJpYyBtdWx0aXNpZyBjb250cmFjdC5cbiAgICpcbiAgICogQHJldHVybnMge1Byb21pc2U8VHJhbnNhY3Rpb25PcFtdPn0gQSBUZXpvcyB0cmFuc2FjdGlvbiBvcGVyYXRpb25cbiAgICovXG4gIHByaXZhdGUgYXN5bmMgYnVpbGRTZW5kVHJhbnNhY3Rpb25Db250ZW50KCk6IFByb21pc2U8VHJhbnNhY3Rpb25PcFtdPiB7XG4gICAgY29uc3QgY29udGVudHM6IFRyYW5zYWN0aW9uT3BbXSA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fdHJhbnNmZXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCB0cmFuc2ZlciA9IHRoaXMuX3RyYW5zZmVyc1tpXS5idWlsZCgpO1xuICAgICAgbGV0IHRyYW5zYWN0aW9uT3A7XG4gICAgICBpZiAoaXNWYWxpZE9yaWdpbmF0ZWRBZGRyZXNzKHRyYW5zZmVyLmZyb20pKSB7XG4gICAgICAgIC8vIE9mZmxpbmUgdHJhbnNhY3Rpb25zIG1heSBub3QgaGF2ZSB0aGUgZGF0YSB0byBzaWduXG4gICAgICAgIGNvbnN0IHNpZ25hdHVyZXMgPSB0cmFuc2Zlci5kYXRhVG9TaWduID8gYXdhaXQgdGhpcy5nZXRTaWduYXR1cmVzKHRyYW5zZmVyLmRhdGFUb1NpZ24pIDogW107XG4gICAgICAgIHRyYW5zYWN0aW9uT3AgPSBtdWx0aXNpZ1RyYW5zYWN0aW9uT3BlcmF0aW9uKFxuICAgICAgICAgIHRoaXMuX2NvdW50ZXIudG9TdHJpbmcoKSxcbiAgICAgICAgICB0aGlzLl9zb3VyY2VBZGRyZXNzLFxuICAgICAgICAgIHRyYW5zZmVyLmFtb3VudCxcbiAgICAgICAgICB0cmFuc2Zlci5mcm9tLFxuICAgICAgICAgIHRyYW5zZmVyLmNvdW50ZXIgfHwgJzAnLFxuICAgICAgICAgIHRyYW5zZmVyLnRvLFxuICAgICAgICAgIHNpZ25hdHVyZXMsXG4gICAgICAgICAgdHJhbnNmZXIuZmVlLmZlZSxcbiAgICAgICAgICB0cmFuc2Zlci5mZWUuZ2FzTGltaXQsXG4gICAgICAgICAgdHJhbnNmZXIuZmVlLnN0b3JhZ2VMaW1pdFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdHJhbnNhY3Rpb25PcCA9IHNpbmdsZXNpZ1RyYW5zYWN0aW9uT3BlcmF0aW9uKFxuICAgICAgICAgIHRoaXMuX2NvdW50ZXIudG9TdHJpbmcoKSxcbiAgICAgICAgICB0aGlzLl9zb3VyY2VBZGRyZXNzLFxuICAgICAgICAgIHRyYW5zZmVyLmFtb3VudCxcbiAgICAgICAgICB0cmFuc2Zlci50byxcbiAgICAgICAgICB0cmFuc2Zlci5mZWUuZmVlLFxuICAgICAgICAgIHRyYW5zZmVyLmZlZS5nYXNMaW1pdCxcbiAgICAgICAgICB0cmFuc2Zlci5mZWUuc3RvcmFnZUxpbWl0XG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBjb250ZW50cy5wdXNoKHRyYW5zYWN0aW9uT3ApO1xuICAgICAgdGhpcy5fY291bnRlciA9IHRoaXMuX2NvdW50ZXIucGx1cygxKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnRlbnRzO1xuICB9XG4gIC8vIGVuZHJlZ2lvblxuXG4gIC8vIHJlZ2lvbiBGb3J3YXJkZXJBZGRyZXNzRGVwbG95bWVudFxuICAvKipcbiAgICogQnVpbGQgYSB0cmFuc2FjdGlvbiBvcGVyYXRpb24gZm9yIGEgZm9yd2FyZGVyIGNvbnRyYWN0XG4gICAqXG4gICAqIEByZXR1cm5zIHtPcmlnaW5hdGlvbk9wfSBhIFRlem9zIHRyYW5zYWN0aW9uIG9wZXJhdGlvblxuICAgKi9cbiAgcHJpdmF0ZSBidWlsZEZvcndhcmRlckRlcGxveW1lbnRDb250ZW50KCk6IE9yaWdpbmF0aW9uT3Age1xuICAgIGNvbnN0IG9wZXJhdGlvbiA9IGZvcndhcmRlck9yaWdpbmF0aW9uT3BlcmF0aW9uKFxuICAgICAgdGhpcy5fZm9yd2FyZGVyRGVzdGluYXRpb24sXG4gICAgICB0aGlzLl9jb3VudGVyLnRvU3RyaW5nKCksXG4gICAgICB0aGlzLl9zb3VyY2VBZGRyZXNzLFxuICAgICAgdGhpcy5fZmVlLmZlZSxcbiAgICAgIHRoaXMuX2ZlZS5nYXNMaW1pdCB8fCBERUZBVUxUX0dBU19MSU1JVC5PUklHSU5BVElPTi50b1N0cmluZygpLFxuICAgICAgdGhpcy5fZmVlLnN0b3JhZ2VMaW1pdCB8fCBERUZBVUxUX1NUT1JBR0VfTElNSVQuT1JJR0lOQVRJT04udG9TdHJpbmcoKSxcbiAgICAgIHRoaXMuX2luaXRpYWxCYWxhbmNlIHx8ICcwJ1xuICAgICk7XG4gICAgdGhpcy5fY291bnRlciA9IHRoaXMuX2NvdW50ZXIucGx1cygxKTtcbiAgICByZXR1cm4gb3BlcmF0aW9uO1xuICB9XG4gIC8vIGVuZHJlZ2lvblxuXG4gIC8vIHJlZ2lvbiBWYWxpZGF0b3JzXG4gIC8qKiBAaW5oZXJpdGRvYyAqL1xuICB2YWxpZGF0ZVZhbHVlKHZhbHVlOiBCaWdOdW1iZXIpOiB2b2lkIHtcbiAgICBpZiAodmFsdWUuaXNMZXNzVGhhbigwKSkge1xuICAgICAgdGhyb3cgbmV3IEJ1aWxkVHJhbnNhY3Rpb25FcnJvcignVmFsdWUgY2Fubm90IGJlIGJlbG93IGxlc3MgdGhhbiB6ZXJvJyk7XG4gICAgfVxuICAgIC8vIFRPRE86IHZhbGlkYXRlIHRoZSBhbW91bnQgaXMgbm90IGJpZ2dlciB0aGFuIHRoZSBtYXggYW1vdW50IGluIFRlem9zXG4gIH1cblxuICAvKiogQGluaGVyaXRkb2MgKi9cbiAgdmFsaWRhdGVBZGRyZXNzKGFkZHJlc3M6IEFkZHJlc3MpOiB2b2lkIHtcbiAgICBpZiAoIWlzVmFsaWRBZGRyZXNzKGFkZHJlc3MuYWRkcmVzcykpIHtcbiAgICAgIHRocm93IG5ldyBCdWlsZFRyYW5zYWN0aW9uRXJyb3IoJ0ludmFsaWQgYWRkcmVzcyAnICsgYWRkcmVzcy5hZGRyZXNzKTtcbiAgICB9XG4gIH1cblxuICAvKiogQGluaGVyaXRkb2MgKi9cbiAgdmFsaWRhdGVLZXkoa2V5OiBCYXNlS2V5KTogdm9pZCB7XG4gICAgY29uc3Qga2V5UGFpciA9IG5ldyBLZXlQYWlyKHsgcHJ2OiBrZXkua2V5IH0pO1xuICAgIGlmICgha2V5UGFpci5nZXRLZXlzKCkucHJ2KSB7XG4gICAgICB0aHJvdyBuZXcgQnVpbGRUcmFuc2FjdGlvbkVycm9yKCdJbnZhbGlkIGtleScpO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBAaW5oZXJpdGRvYyAqL1xuICB2YWxpZGF0ZVJhd1RyYW5zYWN0aW9uKHJhd1RyYW5zYWN0aW9uOiBhbnkpOiB2b2lkIHtcbiAgICAvLyBUT0RPOiB2YWxpZGF0ZSB0aGUgdHJhbnNhY3Rpb24gaXMgZWl0aGVyIGEgSlNPTiBvciBhIGhleFxuICB9XG5cbiAgLyoqIEBpbmhlcml0ZG9jICovXG4gIHZhbGlkYXRlVHJhbnNhY3Rpb24odHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uKTogdm9pZCB7XG4gICAgLy8gVE9ETzogdmFsaWRhdGUgYWxsIHJlcXVpcmVkIGZpZWxkcyBhcmUgcHJlc2VudCBpbiB0aGUgYnVpbGRlciBiZWZvcmUgYnVpbGRJbXBsZW1lbnRhdGlvblxuICAgIHN3aXRjaCAodGhpcy5fdHlwZSkge1xuICAgICAgY2FzZSBUcmFuc2FjdGlvblR5cGUuQWNjb3VudFVwZGF0ZTpcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFRyYW5zYWN0aW9uVHlwZS5XYWxsZXRJbml0aWFsaXphdGlvbjpcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFRyYW5zYWN0aW9uVHlwZS5TZW5kOlxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgVHJhbnNhY3Rpb25UeXBlLkFkZHJlc3NJbml0aWFsaXphdGlvbjpcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFRyYW5zYWN0aW9uVHlwZS5TaW5nbGVTaWdTZW5kOlxuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IG5ldyBCdWlsZFRyYW5zYWN0aW9uRXJyb3IoJ1RyYW5zYWN0aW9uIHR5cGUgbm90IHN1cHBvcnRlZCcpO1xuICAgIH1cbiAgfVxuICAvLyBlbmRyZWdpb25cblxuICAvKiogQGluaGVyaXRkb2MgKi9cbiAgZGlzcGxheU5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5fY29pbkNvbmZpZy5mdWxsTmFtZTtcbiAgfVxuXG4gIC8qKiBAaW5oZXJpdGRvYyAqL1xuICBwcm90ZWN0ZWQgZ2V0IHRyYW5zYWN0aW9uKCk6IFRyYW5zYWN0aW9uIHtcbiAgICByZXR1cm4gdGhpcy5fdHJhbnNhY3Rpb247XG4gIH1cblxuICAvKiogQGluaGVyaXRkb2MgKi9cbiAgcHJvdGVjdGVkIHNldCB0cmFuc2FjdGlvbih0cmFuc2FjdGlvbjogVHJhbnNhY3Rpb24pIHtcbiAgICB0aGlzLl90cmFuc2FjdGlvbiA9IHRyYW5zYWN0aW9uO1xuICB9XG59XG4iXX0=