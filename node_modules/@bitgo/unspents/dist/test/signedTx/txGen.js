"use strict";
/* eslint-disable @typescript-eslint/ban-ts-comment */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.runSignedTransactions = exports.runCombinations = exports.Histogram = exports.TxCombo = exports.createScriptPubKey = void 0;
const utxolib = __importStar(require("@bitgo/utxo-lib"));
const utxo_lib_1 = require("@bitgo/utxo-lib");
const lodash_1 = __importDefault(require("lodash"));
require("lodash.combinations");
const src_1 = require("../../src");
const testutils_1 = require("../testutils");
function createUnspent(pubkeys, inputType, value) {
    let spendableScript;
    const scriptType = inputType === 'taprootKeyPathSpend' ? 'p2trMusig2' : inputType;
    if (scriptType === testutils_1.UnspentTypeP2shP2pk) {
        spendableScript = utxolib.bitgo.outputScripts.createOutputScriptP2shP2pk(pubkeys[0]);
    }
    else if (utxolib.bitgo.outputScripts.isScriptType2Of3(scriptType)) {
        spendableScript = utxolib.bitgo.outputScripts.createOutputScript2of3(pubkeys, scriptType);
    }
    else {
        throw new Error(`unexpected inputType ${scriptType}`);
    }
    return {
        ...spendableScript,
        value,
        inputType: scriptType,
    };
}
/**
 *
 * @param keys - Pubkeys to use for generating the address.
 *               If unspentType is one of UnspentTypePubKeyHash is used, the first key will be used.
 * @param unspentType {String} - one of UnspentTypeScript2of3 or UnspentTypePubKeyHash
 * @return {String} address
 */
const createScriptPubKey = (keys, unspentType) => {
    const pubkeys = keys.map((key) => key.publicKey);
    if (typeof unspentType === 'string' && unspentType in testutils_1.UnspentTypeScript2of3) {
        return createUnspent(pubkeys, unspentType, 0).scriptPubKey;
    }
    const pkHash = utxolib.crypto.hash160(pubkeys[0]);
    switch (unspentType) {
        case testutils_1.UnspentTypePubKeyHash.p2pkh:
            return utxolib.payments.p2pkh({ hash: pkHash }).output;
        case testutils_1.UnspentTypePubKeyHash.p2wpkh:
            return utxolib.payments.p2wpkh({ hash: pkHash }).output;
    }
    if (unspentType instanceof testutils_1.UnspentTypeOpReturn) {
        const payload = Buffer.alloc(unspentType.size).fill(pubkeys[0]);
        return utxolib.script.compile([0x6a, payload]);
    }
    throw new Error(`unsupported output type ${unspentType}`);
};
exports.createScriptPubKey = createScriptPubKey;
const createInputTx = (unspents, inputValue) => {
    const txInputBuilder = new utxolib.bitgo.UtxoTransactionBuilder(utxolib.networks.bitcoin);
    txInputBuilder.addInput(Array(32).fill('01').join(''), 0);
    unspents.forEach(({ scriptPubKey }) => txInputBuilder.addOutput(scriptPubKey, inputValue));
    return txInputBuilder.buildIncomplete();
};
function signInput(txBuilder, index, walletKeys, unspent, signKeys = unspent.inputType === 'p2shP2pk' ? [walletKeys[0]] : [walletKeys[0], walletKeys[2]]) {
    signKeys.forEach((keyPair) => {
        if (unspent.inputType === 'p2shP2pk') {
            utxolib.bitgo.signInputP2shP2pk(txBuilder, index, keyPair);
        }
        else {
            if (signKeys.length !== 2) {
                throw new Error(`invalid signKeys length`);
            }
            const cosigner = keyPair === signKeys[0] ? signKeys[1] : signKeys[0];
            utxolib.bitgo.signInput2Of3(txBuilder, index, unspent.inputType, walletKeys.map((k) => k.publicKey), keyPair, cosigner.publicKey, unspent.value);
        }
    });
}
class TxCombo {
    constructor(walletKeys, inputTypes, outputTypes, expectedDims = src_1.Dimensions.ZERO, signKeys, inputValue = 10) {
        this.walletKeys = walletKeys;
        this.inputTypes = inputTypes;
        this.outputTypes = outputTypes;
        this.expectedDims = expectedDims;
        this.signKeys = signKeys;
        this.inputValue = inputValue;
        this.unspents = inputTypes.map((inputType) => createUnspent(walletKeys.map((key) => key.publicKey), inputType, this.inputValue));
        this.inputTx = createInputTx(this.unspents, inputValue);
    }
    getBuilderWithUnsignedTx() {
        const txBuilder = utxolib.bitgo.createTransactionBuilderForNetwork(utxolib.networks.bitcoin);
        this.inputTx.outs.forEach(({}, i) => txBuilder.addInput(this.inputTx, i));
        this.outputTypes.forEach((unspentType) => txBuilder.addOutput(exports.createScriptPubKey(this.walletKeys, unspentType), this.inputValue));
        return txBuilder;
    }
    getUnsignedTx() {
        return this.getBuilderWithUnsignedTx().buildIncomplete();
    }
    getSignedTx() {
        const txBuilder = this.getBuilderWithUnsignedTx();
        this.unspents.forEach((unspent, i) => {
            signInput(txBuilder, i, this.walletKeys, unspent, this.signKeys);
        });
        return txBuilder.build();
    }
}
exports.TxCombo = TxCombo;
const runCombinations = ({ inputTypes, maxNInputs, outputTypes, maxNOutputs, }, callback) => {
    // Create combinations of different input and output types. Length between 1 and 3.
    const inputCombinations = lodash_1.default.flatten(
    // @ts-ignore
    [...Array(maxNInputs)].map((__, i) => lodash_1.default.combinations(inputTypes, i + 1)));
    const outputCombinations = lodash_1.default.flatten(
    // @ts-ignore
    [...Array(maxNOutputs)].map((__, i) => lodash_1.default.combinations(outputTypes, i + 1)));
    inputCombinations.forEach((inputTypeCombo) => outputCombinations.forEach((outputTypeCombo) => {
        callback(inputTypeCombo, outputTypeCombo);
    }));
};
exports.runCombinations = runCombinations;
class Histogram {
    constructor(map = new Map()) {
        this.map = map;
        this.total = 0;
    }
    add(size) {
        this.map.set(size, (this.map.get(size) || 0) + 1);
        this.total++;
    }
    asSortedArray() {
        return [...this.map.entries()].sort(([a], [b]) => a - b);
    }
    asFullSortedArray() {
        return lodash_1.default.range(this.getPercentile(0), this.getPercentile(1)).map((v) => [v, this.map.get(v) || 0]);
    }
    getPercentile(p) {
        if (0 > p || p > 1) {
            throw new Error(`p must be between 0 and 1`);
        }
        let sum = 0;
        for (const [k, v] of this.asSortedArray()) {
            sum += v;
            if (sum / this.total >= p) {
                return k;
            }
        }
        throw new Error('could not find percentile');
    }
    toString() {
        const keys = [...this.map.keys()].sort((a, b) => a - b);
        return `[${keys.map((k) => `[${k}, ${this.map.get(k)}]`).join(' ')}]`;
    }
}
exports.Histogram = Histogram;
const getKeyTriplets = (prefix, count) => [...Array(count)].map((v, i) => [1, 2, 3].map((j) => utxo_lib_1.bip32.fromSeed(Buffer.alloc(16, `${prefix}/${i}/${j}`), utxolib.networks.bitcoin)));
/**
 *
 * Calls `callback` with a variety of signed txs, based on input parameters
 * Callback arguments are
 *   inputType, inputCount, outputType, txs
 *  where `txs` implements `forEach()`
 *
 * @param inputTypes - input types to test
 * @param nInputKeyTriplets - number of different input key triples to cycle through
 * @param outputTypes - output types to test
 * @param nOutputKeyTriplets - number of different output key triplets to cycle through
 * @param callback
 */
const runSignedTransactions = ({ inputTypes, nInputKeyTriplets, outputTypes, nOutputKeyTriplets, }, callback) => {
    const inputKeyTriplets = getKeyTriplets('test/input/', nInputKeyTriplets);
    const outputKeyTriplets = getKeyTriplets('test/output/', nOutputKeyTriplets);
    const outputValue = 1e8;
    inputTypes.forEach(({ inputType, count: inputCount }) => {
        const inputTxs = inputKeyTriplets.map((inputKeys) => {
            const unspents = [...Array(inputCount)].map(() => createUnspent(inputKeys.map((key) => key.publicKey), inputType, outputValue));
            const inputTx = createInputTx(unspents, outputValue);
            return { inputKeys, unspents, inputTx };
        });
        outputTypes.forEach((outputType) => {
            const outputs = outputKeyTriplets.map((outputKeys) => exports.createScriptPubKey(outputKeys, outputType));
            const txs = {
                forEach(cb) {
                    inputTxs.forEach(({ inputKeys, unspents, inputTx }) => {
                        outputs.forEach((scriptPubKey) => {
                            const txBuilder = utxolib.bitgo.createTransactionBuilderForNetwork(utxolib.networks.bitcoin);
                            inputTx.outs.forEach((v, i) => txBuilder.addInput(inputTx, i));
                            txBuilder.addOutput(scriptPubKey, outputValue);
                            unspents.forEach((unspent, i) => {
                                signInput(txBuilder, i, inputKeys, unspent);
                            });
                            cb(txBuilder.build());
                        });
                    });
                },
            };
            callback(inputType, inputCount, outputType, txs);
        });
    });
};
exports.runSignedTransactions = runSignedTransactions;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHhHZW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi90ZXN0L3NpZ25lZFR4L3R4R2VuLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxzREFBc0Q7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFdEQseURBQTJDO0FBQzNDLDhDQUF3RDtBQUN4RCxvREFBdUI7QUFDdkIsK0JBQTZCO0FBQzdCLG1DQUF1QztBQUN2Qyw0Q0FPc0I7QUFVdEIsU0FBUyxhQUFhLENBQUMsT0FBaUIsRUFBRSxTQUFpQixFQUFFLEtBQWE7SUFDeEUsSUFBSSxlQUFlLENBQUM7SUFDcEIsTUFBTSxVQUFVLEdBQUcsU0FBUyxLQUFLLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztJQUNsRixJQUFJLFVBQVUsS0FBSywrQkFBbUIsRUFBRTtRQUN0QyxlQUFlLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsMEJBQTBCLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDdEY7U0FBTSxJQUFJLE9BQU8sQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxFQUFFO1FBQ25FLGVBQWUsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLENBQUM7S0FDM0Y7U0FBTTtRQUNMLE1BQU0sSUFBSSxLQUFLLENBQUMsd0JBQXdCLFVBQVUsRUFBRSxDQUFDLENBQUM7S0FDdkQ7SUFFRCxPQUFPO1FBQ0wsR0FBRyxlQUFlO1FBQ2xCLEtBQUs7UUFDTCxTQUFTLEVBQUUsVUFBVTtLQUN0QixDQUFDO0FBQ0osQ0FBQztBQUVEOzs7Ozs7R0FNRztBQUNJLE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxJQUFzQixFQUFFLFdBQTRCLEVBQVUsRUFBRTtJQUNqRyxNQUFNLE9BQU8sR0FBRyxJQUFJ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LFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQzs0QkFDNUUsU0FBUyxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsV0FBVyxDQUFDLENBQUM7NEJBQy9DLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0NBQzlCLFNBQVMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQzs0QkFDOUMsQ0FBQyxDQUFDLENBQUM7NEJBRUgsRUFBRSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO3dCQUN4QixDQUFDLENBQUMsQ0FBQztvQkFDTCxDQUFDLENBQUMsQ0FBQztnQkFDTCxDQUFDO2FBQ0YsQ0FBQztZQUVGLFFBQVEsQ0FBQyxTQUFTLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNuRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDO0FBRTRDLHNEQUFxQiIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9iYW4tdHMtY29tbWVudCAqL1xuXG5pbXBvcnQgKiBhcyB1dHhvbGliIGZyb20gJ0BiaXRnby91dHhvLWxpYic7XG5pbXBvcnQgeyBiaXAzMiwgQklQMzJJbnRlcmZhY2UgfSBmcm9tICdAYml0Z28vdXR4by1saWInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAnbG9kYXNoLmNvbWJpbmF0aW9ucyc7XG5pbXBvcnQgeyBEaW1lbnNpb25zIH0gZnJvbSAnLi4vLi4vc3JjJztcbmltcG9ydCB7XG4gIElucHV0U2NyaXB0VHlwZSxcbiAgVGVzdFVuc3BlbnRUeXBlLFxuICBVbnNwZW50VHlwZU9wUmV0dXJuLFxuICBVbnNwZW50VHlwZVAyc2hQMnBrLFxuICBVbnNwZW50VHlwZVB1YktleUhhc2gsXG4gIFVuc3BlbnRUeXBlU2NyaXB0Mm9mMyxcbn0gZnJvbSAnLi4vdGVzdHV0aWxzJztcblxuaW50ZXJmYWNlIElVbnNwZW50IHtcbiAgc2NyaXB0UHViS2V5OiBCdWZmZXI7XG4gIHJlZGVlbVNjcmlwdD86IEJ1ZmZlcjtcbiAgd2l0bmVzc1NjcmlwdD86IEJ1ZmZlcjtcbiAgdmFsdWU6IG51bWJlcjtcbiAgaW5wdXRUeXBlOiB1dHhvbGliLmJpdGdvLm91dHB1dFNjcmlwdHMuU2NyaXB0VHlwZTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlVW5zcGVudChwdWJrZXlzOiBCdWZmZXJbXSwgaW5wdXRUeXBlOiBzdHJpbmcsIHZhbHVlOiBudW1iZXIpOiBJVW5zcGVudCB7XG4gIGxldCBzcGVuZGFibGVTY3JpcHQ7XG4gIGNvbnN0IHNjcmlwdFR5cGUgPSBpbnB1dFR5cGUgPT09ICd0YXByb290S2V5UGF0aFNwZW5kJyA/ICdwMnRyTXVzaWcyJyA6IGlucHV0VHlwZTtcbiAgaWYgKHNjcmlwdFR5cGUgPT09IFVuc3BlbnRUeXBlUDJzaFAycGspIHtcbiAgICBzcGVuZGFibGVTY3JpcHQgPSB1dHhvbGliLmJpdGdvLm91dHB1dFNjcmlwdHMuY3JlYXRlT3V0cHV0U2NyaXB0UDJzaFAycGsocHVia2V5c1swXSk7XG4gIH0gZWxzZSBpZiAodXR4b2xpYi5iaXRnby5vdXRwdXRTY3JpcHRzLmlzU2NyaXB0VHlwZTJPZjMoc2NyaXB0VHlwZSkpIHtcbiAgICBzcGVuZGFibGVTY3JpcHQgPSB1dHhvbGliLmJpdGdvLm91dHB1dFNjcmlwdHMuY3JlYXRlT3V0cHV0U2NyaXB0Mm9mMyhwdWJrZXlzLCBzY3JpcHRUeXBlKTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYHVuZXhwZWN0ZWQgaW5wdXRUeXBlICR7c2NyaXB0VHlwZX1gKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgLi4uc3BlbmRhYmxlU2NyaXB0LFxuICAgIHZhbHVlLFxuICAgIGlucHV0VHlwZTogc2NyaXB0VHlwZSxcbiAgfTtcbn1cblxuLyoqXG4gKlxuICogQHBhcmFtIGtleXMgLSBQdWJrZXlzIHRvIHVzZSBmb3IgZ2VuZXJhdGluZyB0aGUgYWRkcmVzcy5cbiAqICAgICAgICAgICAgICAgSWYgdW5zcGVudFR5cGUgaXMgb25lIG9mIFVuc3BlbnRUeXBlUHViS2V5SGFzaCBpcyB1c2VkLCB0aGUgZmlyc3Qga2V5IHdpbGwgYmUgdXNlZC5cbiAqIEBwYXJhbSB1bnNwZW50VHlwZSB7U3RyaW5nfSAtIG9uZSBvZiBVbnNwZW50VHlwZVNjcmlwdDJvZjMgb3IgVW5zcGVudFR5cGVQdWJLZXlIYXNoXG4gKiBAcmV0dXJuIHtTdHJpbmd9IGFkZHJlc3NcbiAqL1xuZXhwb3J0IGNvbnN0IGNyZWF0ZVNjcmlwdFB1YktleSA9IChrZXlzOiBCSVAzMkludGVyZmFjZVtdLCB1bnNwZW50VHlwZTogVGVzdFVuc3BlbnRUeXBlKTogQnVmZmVyID0+IHtcbiAgY29uc3QgcHVia2V5cyA9IGtleXMubWFwKChrZXkpID0+IGtleS5wdWJsaWNLZXkpO1xuICBpZiAodHlwZW9mIHVuc3BlbnRUeXBlID09PSAnc3RyaW5nJyAmJiB1bnNwZW50VHlwZSBpbiBVbnNwZW50VHlwZVNjcmlwdDJvZjMpIHtcbiAgICByZXR1cm4gY3JlYXRlVW5zcGVudChwdWJrZXlzLCB1bnNwZW50VHlwZSwgMCkuc2NyaXB0UHViS2V5O1xuICB9XG5cbiAgY29uc3QgcGtIYXNoID0gdXR4b2xpYi5jcnlwdG8uaGFzaDE2MChwdWJrZXlzWzBdKTtcbiAgc3dpdGNoICh1bnNwZW50VHlwZSkge1xuICAgIGNhc2UgVW5zcGVudFR5cGVQdWJLZXlIYXNoLnAycGtoOlxuICAgICAgcmV0dXJuIHV0eG9saWIucGF5bWVudHMucDJwa2goeyBoYXNoOiBwa0hhc2ggfSkub3V0cHV0ITtcbiAgICBjYXNlIFVuc3BlbnRUeXBlUHViS2V5SGFzaC5wMndwa2g6XG4gICAgICByZXR1cm4gdXR4b2xpYi5wYXltZW50cy5wMndwa2goeyBoYXNoOiBwa0hhc2ggfSkub3V0cHV0ITtcbiAgfVxuXG4gIGlmICh1bnNwZW50VHlwZSBpbnN0YW5jZW9mIFVuc3BlbnRUeXBlT3BSZXR1cm4pIHtcbiAgICBjb25zdCBwYXlsb2FkID0gQnVmZmVyLmFsbG9jKHVuc3BlbnRUeXBlLnNpemUpLmZpbGwocHVia2V5c1swXSk7XG4gICAgcmV0dXJuIHV0eG9saWIuc2NyaXB0LmNvbXBpbGUoWzB4NmEsIHBheWxvYWRdKTtcbiAgfVxuXG4gIHRocm93IG5ldyBFcnJvcihgdW5zdXBwb3J0ZWQgb3V0cHV0IHR5cGUgJHt1bnNwZW50VHlwZX1gKTtcbn07XG5cbmNvbnN0IGNyZWF0ZUlucHV0VHggPSAodW5zcGVudHM6IGFueVtdLCBpbnB1dFZhbHVlOiBudW1iZXIpID0+IHtcbiAgY29uc3QgdHhJbnB1dEJ1aWxkZXIgPSBuZXcgdXR4b2xpYi5iaXRnby5VdHhvVHJhbnNhY3Rpb25CdWlsZGVyKHV0eG9saWIubmV0d29ya3MuYml0Y29pbik7XG4gIHR4SW5wdXRCdWlsZGVyLmFkZElucHV0KEFycmF5KDMyKS5maWxsKCcwMScpLmpvaW4oJycpLCAwKTtcbiAgdW5zcGVudHMuZm9yRWFjaCgoeyBzY3JpcHRQdWJLZXkgfSkgPT4gdHhJbnB1dEJ1aWxkZXIuYWRkT3V0cHV0KHNjcmlwdFB1YktleSwgaW5wdXRWYWx1ZSkpO1xuICByZXR1cm4gdHhJbnB1dEJ1aWxkZXIuYnVpbGRJbmNvbXBsZXRlKCk7XG59O1xuXG5mdW5jdGlvbiBzaWduSW5wdXQoXG4gIHR4QnVpbGRlcjogdXR4b2xpYi5iaXRnby5VdHhvVHJhbnNhY3Rpb25CdWlsZGVyLFxuICBpbmRleDogbnVtYmVyLFxuICB3YWxsZXRLZXlzOiBCSVAzMkludGVyZmFjZVtdLFxuICB1bnNwZW50OiBJVW5zcGVudCxcbiAgc2lnbktleXM6IEJJUDMySW50ZXJmYWNlW10gPSB1bnNwZW50LmlucHV0VHlwZSA9PT0gJ3Ayc2hQMnBrJyA/IFt3YWxsZXRLZXlzWzBdXSA6IFt3YWxsZXRLZXlzWzBdLCB3YWxsZXRLZXlzWzJdXVxuKSB7XG4gIHNpZ25LZXlzLmZvckVhY2goKGtleVBhaXIpID0+IHtcbiAgICBpZiAodW5zcGVudC5pbnB1dFR5cGUgPT09ICdwMnNoUDJwaycpIHtcbiAgICAgIHV0eG9saWIuYml0Z28uc2lnbklucHV0UDJzaFAycGsodHhCdWlsZGVyLCBpbmRleCwga2V5UGFpcik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChzaWduS2V5cy5sZW5ndGggIT09IDIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBpbnZhbGlkIHNpZ25LZXlzIGxlbmd0aGApO1xuICAgICAgfVxuICAgICAgY29uc3QgY29zaWduZXIgPSBrZXlQYWlyID09PSBzaWduS2V5c1swXSA/IHNpZ25LZXlzWzFdIDogc2lnbktleXNbMF07XG4gICAgICB1dHhvbGliLmJpdGdvLnNpZ25JbnB1dDJPZjMoXG4gICAgICAgIHR4QnVpbGRlcixcbiAgICAgICAgaW5kZXgsXG4gICAgICAgIHVuc3BlbnQuaW5wdXRUeXBlLFxuICAgICAgICB3YWxsZXRLZXlzLm1hcCgoaykgPT4gay5wdWJsaWNLZXkpIGFzIHV0eG9saWIuYml0Z28uVHJpcGxlPEJ1ZmZlcj4sXG4gICAgICAgIGtleVBhaXIsXG4gICAgICAgIGNvc2lnbmVyLnB1YmxpY0tleSxcbiAgICAgICAgdW5zcGVudC52YWx1ZVxuICAgICAgKTtcbiAgICB9XG4gIH0pO1xufVxuXG5jbGFzcyBUeENvbWJvIHtcbiAgcHVibGljIHVuc3BlbnRzOiBJVW5zcGVudFtdO1xuICBwdWJsaWMgaW5wdXRUeDogYW55O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyB3YWxsZXRLZXlzOiBCSVAzMkludGVyZmFjZVtdLFxuICAgIHB1YmxpYyBpbnB1dFR5cGVzOiBzdHJpbmdbXSxcbiAgICBwdWJsaWMgb3V0cHV0VHlwZXM6IFRlc3RVbnNwZW50VHlwZVtdLFxuICAgIHB1YmxpYyBleHBlY3RlZERpbXM6IFJlYWRvbmx5PERpbWVuc2lvbnM+ID0gRGltZW5zaW9ucy5aRVJPLFxuICAgIHB1YmxpYyBzaWduS2V5cz86IEJJUDMySW50ZXJmYWNlW10sXG4gICAgcHVibGljIGlucHV0VmFsdWU6IG51bWJlciA9IDEwXG4gICkge1xuICAgIHRoaXMudW5zcGVudHMgPSBpbnB1dFR5cGVzLm1hcCgoaW5wdXRUeXBlKSA9PlxuICAgICAgY3JlYXRlVW5zcGVudChcbiAgICAgICAgd2FsbGV0S2V5cy5tYXAoKGtleSkgPT4ga2V5LnB1YmxpY0tleSksXG4gICAgICAgIGlucHV0VHlwZSxcbiAgICAgICAgdGhpcy5pbnB1dFZhbHVlXG4gICAgICApXG4gICAgKTtcbiAgICB0aGlzLmlucHV0VHggPSBjcmVhdGVJbnB1dFR4KHRoaXMudW5zcGVudHMsIGlucHV0VmFsdWUpO1xuICB9XG5cbiAgcHVibGljIGdldEJ1aWxkZXJXaXRoVW5zaWduZWRUeCgpOiB1dHhvbGliLmJpdGdvLlV0eG9UcmFuc2FjdGlvbkJ1aWxkZXIge1xuICAgIGNvbnN0IHR4QnVpbGRlciA9IHV0eG9saWIuYml0Z28uY3JlYXRlVHJhbnNhY3Rpb25CdWlsZGVyRm9yTmV0d29yayh1dHhvbGliLm5ldHdvcmtzLmJpdGNvaW4pO1xuICAgIHRoaXMuaW5wdXRUeC5vdXRzLmZvckVhY2goKHt9LCBpOiBudW1iZXIpID0+IHR4QnVpbGRlci5hZGRJbnB1dCh0aGlzLmlucHV0VHgsIGkpKTtcbiAgICB0aGlzLm91dHB1dFR5cGVzLmZvckVhY2goKHVuc3BlbnRUeXBlKSA9PlxuICAgICAgdHhCdWlsZGVyLmFkZE91dHB1dChjcmVhdGVTY3JpcHRQdWJLZXkodGhpcy53YWxsZXRLZXlzLCB1bnNwZW50VHlwZSksIHRoaXMuaW5wdXRWYWx1ZSlcbiAgICApO1xuICAgIHJldHVybiB0eEJ1aWxkZXI7XG4gIH1cblxuICBwdWJsaWMgZ2V0VW5zaWduZWRUeCgpOiB1dHhvbGliLmJpdGdvLlV0eG9UcmFuc2FjdGlvbiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0QnVpbGRlcldpdGhVbnNpZ25lZFR4KCkuYnVpbGRJbmNvbXBsZXRlKCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0U2lnbmVkVHgoKTogdXR4b2xpYi5UcmFuc2FjdGlvbiB7XG4gICAgY29uc3QgdHhCdWlsZGVyID0gdGhpcy5nZXRCdWlsZGVyV2l0aFVuc2lnbmVkVHgoKTtcbiAgICB0aGlzLnVuc3BlbnRzLmZvckVhY2goKHVuc3BlbnQsIGkpID0+IHtcbiAgICAgIHNpZ25JbnB1dCh0eEJ1aWxkZXIsIGksIHRoaXMud2FsbGV0S2V5cywgdW5zcGVudCwgdGhpcy5zaWduS2V5cyk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHR4QnVpbGRlci5idWlsZCgpO1xuICB9XG59XG5cbmNvbnN0IHJ1bkNvbWJpbmF0aW9ucyA9IChcbiAge1xuICAgIGlucHV0VHlwZXMsXG4gICAgbWF4TklucHV0cyxcbiAgICBvdXRwdXRUeXBlcyxcbiAgICBtYXhOT3V0cHV0cyxcbiAgfToge1xuICAgIGlucHV0VHlwZXM6IElucHV0U2NyaXB0VHlwZVtdO1xuICAgIG1heE5JbnB1dHM6IG51bWJlcjtcbiAgICBvdXRwdXRUeXBlczogVGVzdFVuc3BlbnRUeXBlW107XG4gICAgbWF4Tk91dHB1dHM6IG51bWJlcjtcbiAgfSxcbiAgY2FsbGJhY2s6IChpbnB1dENvbWJvOiBJbnB1dFNjcmlwdFR5cGVbXSwgb3V0cHV0Q29tYm86IFRlc3RVbnNwZW50VHlwZVtdKSA9PiB2b2lkXG4pOiB2b2lkID0+IHtcbiAgLy8gQ3JlYXRlIGNvbWJpbmF0aW9ucyBvZiBkaWZmZXJlbnQgaW5wdXQgYW5kIG91dHB1dCB0eXBlcy4gTGVuZ3RoIGJldHdlZW4gMSBhbmQgMy5cbiAgY29uc3QgaW5wdXRDb21iaW5hdGlvbnMgPSBfLmZsYXR0ZW4oXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIFsuLi5BcnJheShtYXhOSW5wdXRzKV0ubWFwKChfXywgaSkgPT4gXy5jb21iaW5hdGlvbnMoaW5wdXRUeXBlcywgaSArIDEpKVxuICApO1xuICBjb25zdCBvdXRwdXRDb21iaW5hdGlvbnMgPSBfLmZsYXR0ZW4oXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIFsuLi5BcnJheShtYXhOT3V0cHV0cyldLm1hcCgoX18sIGkpID0+IF8uY29tYmluYXRpb25zKG91dHB1dFR5cGVzLCBpICsgMSkpXG4gICk7XG5cbiAgaW5wdXRDb21iaW5hdGlvbnMuZm9yRWFjaCgoaW5wdXRUeXBlQ29tYm8pID0+XG4gICAgb3V0cHV0Q29tYmluYXRpb25zLmZvckVhY2goKG91dHB1dFR5cGVDb21ibykgPT4ge1xuICAgICAgY2FsbGJhY2soaW5wdXRUeXBlQ29tYm8sIG91dHB1dFR5cGVDb21ibyk7XG4gICAgfSlcbiAgKTtcbn07XG5cbmNsYXNzIEhpc3RvZ3JhbSB7XG4gIHB1YmxpYyB0b3RhbCA9IDA7XG5cbiAgY29uc3RydWN0b3IocHVibGljIG1hcDogTWFwPG51bWJlciwgbnVtYmVyPiA9IG5ldyBNYXAoKSkge31cblxuICBwdWJsaWMgYWRkKHNpemU6IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMubWFwLnNldChzaXplLCAodGhpcy5tYXAuZ2V0KHNpemUpIHx8IDApICsgMSk7XG4gICAgdGhpcy50b3RhbCsrO1xuICB9XG5cbiAgcHVibGljIGFzU29ydGVkQXJyYXkoKTogbnVtYmVyW11bXSB7XG4gICAgcmV0dXJuIFsuLi50aGlzLm1hcC5lbnRyaWVzKCldLnNvcnQoKFthXSwgW2JdKSA9PiBhIC0gYik7XG4gIH1cblxuICBwdWJsaWMgYXNGdWxsU29ydGVkQXJyYXkoKTogbnVtYmVyW11bXSB7XG4gICAgcmV0dXJuIF8ucmFuZ2UodGhpcy5nZXRQZXJjZW50aWxlKDApLCB0aGlzLmdldFBlcmNlbnRpbGUoMSkpLm1hcCgodikgPT4gW3YsIHRoaXMubWFwLmdldCh2KSB8fCAwXSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0UGVyY2VudGlsZShwOiBudW1iZXIpOiBudW1iZXIge1xuICAgIGlmICgwID4gcCB8fCBwID4gMSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBwIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxYCk7XG4gICAgfVxuXG4gICAgbGV0IHN1bSA9IDA7XG4gICAgZm9yIChjb25zdCBbaywgdl0gb2YgdGhpcy5hc1NvcnRlZEFycmF5KCkpIHtcbiAgICAgIHN1bSArPSB2O1xuICAgICAgaWYgKHN1bSAvIHRoaXMudG90YWwgPj0gcCkge1xuICAgICAgICByZXR1cm4gaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoJ2NvdWxkIG5vdCBmaW5kIHBlcmNlbnRpbGUnKTtcbiAgfVxuXG4gIHB1YmxpYyB0b1N0cmluZygpOiBzdHJpbmcge1xuICAgIGNvbnN0IGtleXMgPSBbLi4udGhpcy5tYXAua2V5cygpXS5zb3J0KChhLCBiKSA9PiBhIC0gYik7XG4gICAgcmV0dXJuIGBbJHtrZXlzLm1hcCgoaykgPT4gYFske2t9LCAke3RoaXMubWFwLmdldChrKX1dYCkuam9pbignICcpfV1gO1xuICB9XG59XG5cbmNvbnN0IGdldEtleVRyaXBsZXRzID0gKHByZWZpeDogc3RyaW5nLCBjb3VudDogbnVtYmVyKSA9PlxuICBbLi4uQXJyYXkoY291bnQpXS5tYXAoKHYsIGkpID0+XG4gICAgWzEsIDIsIDNdLm1hcCgoaikgPT4gYmlwMzIuZnJvbVNlZWQoQnVmZmVyLmFsbG9jKDE2LCBgJHtwcmVmaXh9LyR7aX0vJHtqfWApLCB1dHhvbGliLm5ldHdvcmtzLmJpdGNvaW4pKVxuICApO1xuXG4vKipcbiAqXG4gKiBDYWxscyBgY2FsbGJhY2tgIHdpdGggYSB2YXJpZXR5IG9mIHNpZ25lZCB0eHMsIGJhc2VkIG9uIGlucHV0IHBhcmFtZXRlcnNcbiAqIENhbGxiYWNrIGFyZ3VtZW50cyBhcmVcbiAqICAgaW5wdXRUeXBlLCBpbnB1dENvdW50LCBvdXRwdXRUeXBlLCB0eHNcbiAqICB3aGVyZSBgdHhzYCBpbXBsZW1lbnRzIGBmb3JFYWNoKClgXG4gKlxuICogQHBhcmFtIGlucHV0VHlwZXMgLSBpbnB1dCB0eXBlcyB0byB0ZXN0XG4gKiBAcGFyYW0gbklucHV0S2V5VHJpcGxldHMgLSBudW1iZXIgb2YgZGlmZmVyZW50IGlucHV0IGtleSB0cmlwbGVzIHRvIGN5Y2xlIHRocm91Z2hcbiAqIEBwYXJhbSBvdXRwdXRUeXBlcyAtIG91dHB1dCB0eXBlcyB0byB0ZXN0XG4gKiBAcGFyYW0gbk91dHB1dEtleVRyaXBsZXRzIC0gbnVtYmVyIG9mIGRpZmZlcmVudCBvdXRwdXQga2V5IHRyaXBsZXRzIHRvIGN5Y2xlIHRocm91Z2hcbiAqIEBwYXJhbSBjYWxsYmFja1xuICovXG5jb25zdCBydW5TaWduZWRUcmFuc2FjdGlvbnMgPSAoXG4gIHtcbiAgICBpbnB1dFR5cGVzLFxuICAgIG5JbnB1dEtleVRyaXBsZXRzLFxuICAgIG91dHB1dFR5cGVzLFxuICAgIG5PdXRwdXRLZXlUcmlwbGV0cyxcbiAgfToge1xuICAgIGlucHV0VHlwZXM6IEFycmF5PHsgaW5wdXRUeXBlOiBzdHJpbmc7IGNvdW50OiBudW1iZXIgfT47XG4gICAgbklucHV0S2V5VHJpcGxldHM6IG51bWJlcjtcbiAgICBvdXRwdXRUeXBlczogVGVzdFVuc3BlbnRUeXBlW107XG4gICAgbk91dHB1dEtleVRyaXBsZXRzOiBudW1iZXI7XG4gIH0sXG4gIGNhbGxiYWNrOiAoaW5wdXRUeXBlOiBzdHJpbmcsIGlucHV0Q291bnQ6IG51bWJlciwgb3V0cHV0VHlwZTogVGVzdFVuc3BlbnRUeXBlLCB0eHM6IGFueSkgPT4gdm9pZFxuKTogdm9pZCA9PiB7XG4gIGNvbnN0IGlucHV0S2V5VHJpcGxldHMgPSBnZXRLZXlUcmlwbGV0cygndGVzdC9pbnB1dC8nLCBuSW5wdXRLZXlUcmlwbGV0cyk7XG4gIGNvbnN0IG91dHB1dEtleVRyaXBsZXRzID0gZ2V0S2V5VHJpcGxldHMoJ3Rlc3Qvb3V0cHV0LycsIG5PdXRwdXRLZXlUcmlwbGV0cyk7XG4gIGNvbnN0IG91dHB1dFZhbHVlID0gMWU4O1xuXG4gIGlucHV0VHlwZXMuZm9yRWFjaCgoeyBpbnB1dFR5cGUsIGNvdW50OiBpbnB1dENvdW50IH0pID0+IHtcbiAgICBjb25zdCBpbnB1dFR4cyA9IGlucHV0S2V5VHJpcGxldHMubWFwKChpbnB1dEtleXMpID0+IHtcbiAgICAgIGNvbnN0IHVuc3BlbnRzID0gWy4uLkFycmF5KGlucHV0Q291bnQpXS5tYXAoKCkgPT5cbiAgICAgICAgY3JlYXRlVW5zcGVudChcbiAgICAgICAgICBpbnB1dEtleXMubWFwKChrZXkpID0+IGtleS5wdWJsaWNLZXkpLFxuICAgICAgICAgIGlucHV0VHlwZSxcbiAgICAgICAgICBvdXRwdXRWYWx1ZVxuICAgICAgICApXG4gICAgICApO1xuICAgICAgY29uc3QgaW5wdXRUeCA9IGNyZWF0ZUlucHV0VHgodW5zcGVudHMsIG91dHB1dFZhbHVlKTtcbiAgICAgIHJldHVybiB7IGlucHV0S2V5cywgdW5zcGVudHMsIGlucHV0VHggfTtcbiAgICB9KTtcblxuICAgIG91dHB1dFR5cGVzLmZvckVhY2goKG91dHB1dFR5cGUpID0+IHtcbiAgICAgIGNvbnN0IG91dHB1dHMgPSBvdXRwdXRLZXlUcmlwbGV0cy5tYXAoKG91dHB1dEtleXMpID0+IGNyZWF0ZVNjcmlwdFB1YktleShvdXRwdXRLZXlzLCBvdXRwdXRUeXBlKSk7XG5cbiAgICAgIGNvbnN0IHR4cyA9IHtcbiAgICAgICAgZm9yRWFjaChjYjogKHR4OiB1dHhvbGliLlRyYW5zYWN0aW9uKSA9PiB2b2lkKSB7XG4gICAgICAgICAgaW5wdXRUeHMuZm9yRWFjaCgoeyBpbnB1dEtleXMsIHVuc3BlbnRzLCBpbnB1dFR4IH0pID0+IHtcbiAgICAgICAgICAgIG91dHB1dHMuZm9yRWFjaCgoc2NyaXB0UHViS2V5KSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IHR4QnVpbGRlciA9IHV0eG9saWIuYml0Z28uY3JlYXRlVHJhbnNhY3Rpb25CdWlsZGVyRm9yTmV0d29yayh1dHhvbGliLm5ldHdvcmtzLmJpdGNvaW4pO1xuICAgICAgICAgICAgICBpbnB1dFR4Lm91dHMuZm9yRWFjaCgodjogYW55LCBpOiBudW1iZXIpID0+IHR4QnVpbGRlci5hZGRJbnB1dChpbnB1dFR4LCBpKSk7XG4gICAgICAgICAgICAgIHR4QnVpbGRlci5hZGRPdXRwdXQoc2NyaXB0UHViS2V5LCBvdXRwdXRWYWx1ZSk7XG4gICAgICAgICAgICAgIHVuc3BlbnRzLmZvckVhY2goKHVuc3BlbnQsIGkpID0+IHtcbiAgICAgICAgICAgICAgICBzaWduSW5wdXQodHhCdWlsZGVyLCBpLCBpbnB1dEtleXMsIHVuc3BlbnQpO1xuICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICBjYih0eEJ1aWxkZXIuYnVpbGQoKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSxcbiAgICAgIH07XG5cbiAgICAgIGNhbGxiYWNrKGlucHV0VHlwZSwgaW5wdXRDb3VudCwgb3V0cHV0VHlwZSwgdHhzKTtcbiAgICB9KTtcbiAgfSk7XG59O1xuXG5leHBvcnQgeyBUeENvbWJvLCBIaXN0b2dyYW0sIHJ1bkNvbWJpbmF0aW9ucywgcnVuU2lnbmVkVHJhbnNhY3Rpb25zIH07XG4iXX0=